cbs = window.cbs || {};

var CamLogin = (function () {
    const qsCache = {};
    let uidInput;
    let uidLabel;
    let waitElement;
    let processElement;
    let errorElement;
    let encapForm;
    let pinTanForm;
    let eIdFields;
    let oneClickButtons;
    let oneClickDeeplink;
    let oneClickAbort;
    let oneClickShowEid;
    let qrCodeTemplate;
    let templateBody;

    let useridAuthCodeWrapper;
    let oneclickAuthCodeWrapper;
    let authCodeEl;
    let authCodeInfo;

    let isFTN;
    let isOneClick = false;
    let oneClickOnline;
    let tabs;

    let paybuttons;
    let paybuttonApprove;

    let refreshQrTimeout = 0;
    let newQrId;

    let isNetbank = false;

    let agent;
    let isAbfWebview = false;
    let worker;

    let workerUrl = cbs.contextPath + '/authflow/main/js/cbs-worker.min.js?' + cbs.version;
    let workerCreated = false;

    let qrCodeDialog;
    let qrDialogButton;
    let qrImage;
    let qrCodeButton;

    const csrfKey = qs("meta[name='_csrf_header']")?.getAttribute('content');
    const csrfValue = qs("meta[name='_csrf']")?.getAttribute('content');

    document.addEventListener('DOMContentLoaded', async function() {
        agent = navigator.userAgent.toLowerCase();

        isAbfWebview = agent.includes('alandsbanken') || agent.includes('openbankingauthorization');
        isOneClick = (isMobile() && !detectWebview()) || isAbfWebview;

        qrCodeTemplate = qs('#qrcode');
        qrCodeButton = qs('#qr-img-wrapper');
        templateBody = qs('#ENCAP');
        eIdFields = qs('#eId-fields');
        encapForm = qs("#encapLoginForm");
        waitElement = qs('.spinner');
        processElement = qs('#processStatus');
        errorElement = qs('#dataError');
        uidLabel = qs('#js_error-mark-label');
        uidInput = qs('#encapUsername');
        oneClickButtons = qs('.app2app-buttons');
        oneClickDeeplink = qs('a[data-link-type="app2app"]');
        oneClickAbort = qs('.app2app-abort a');
        oneClickShowEid = qs('a[data-link-type="eid"]');
        switchBetweenQrAndEncapButton = qs('#switchBetweenQrAndEncap');
        tabs = qs('.c_tab-navigation__item');
        qrCodeDialog = $('#qr-dialog');

        useridAuthCodeWrapper = qs('.authentication-code-processing .authentication-code-wrapper');
        oneclickAuthCodeWrapper = qs('.authentication-code-oneclick .authentication-code-wrapper');
        paybuttons = qs('#paybuttons');
        qrDialogButton = qs('#qrCloseDialog');
        qrImage =  $("#qrImage");

        qrDialogSetup();
        qrZoomSetup();

        if(paybuttons) {
            pinTanForm = qs('[name="loginForm"]');
            paybuttonApprove = qs('[name="btn_login"]', paybuttons);
        }

        isFTN = location.href.includes('/ftn/');
        if(isFTN) pinTanForm = qs('#CREDENTIALS_FORM');
        if(!paybuttons && !isFTN) {
            pinTanForm = qs('#login');
            isNetbank = true;
        }

        if (encapSelectedTab()) {
            CBSQrCode.loadQr(cbs.qrId, isFTN);
        }

        oneClickOnline = window.cbs.oneClickOnline === 'true';

        if(!isMobile()) {
            if (qrCodeTemplate.classList.contains('hidden')) {
                qrCodeTemplate.classList.remove('hidden');
            }
            labelForQrButton(labels.lbl_btn_switch_between_qr_encap);
            if (encapSelectedTab()) {
                startWorkersPolling();
                fetchNewQrCode();
            }
        } else {
            switchBetweenQrAndEncapButton.classList.add('hidden');
            qrCodeTemplate.classList.add('hidden');
            await uiInit();
        }

        // --------------
        // QR CODE BUTTON HANDLER
        // --------------
        switchBetweenQrAndEncapButton.addEventListener('click', async function () {

            if (encapForm.classList.contains('hidden')) {
                waitElement.classList.add('hidden');
                processElement.classList.add('hidden');
                useridAuthCodeWrapper.classList.add('hidden');
                encapForm.classList.remove('hidden');
            }

            if (eIdFields.classList.contains('hidden')) {
                qrCodeTemplate.classList.add('hidden');
                oneClickButtons.classList.add('hidden');
                labelForQrButton(labels.lbl_btn_switch_between_encap_qr);
                uiResetEidError();
                await uiInit();
            } else {
                eIdFields.classList.add('hidden');
                qrCodeTemplate.classList.remove('hidden');
                labelForQrButton(labels.lbl_btn_switch_between_qr_encap);
                newQrId = await CBSQrCode.fetchNewQrCode();
                CBSQrCode.loadQr(newQrId.qrId, isFTN);
                startWorkersPolling();
                fetchNewQrCode();
            }
        });


        function fetchNewQrCode() {
            refreshQrTimeout = setTimeout(async () => {
                newQrId = await CBSQrCode.fetchNewQrCode();
                CBSQrCode.loadQr(newQrId.qrId, isFTN);
                terminateWebWorker();
                startWorkersPolling();
                fetchNewQrCode();
            }, 20000);
        }


        // --------------
        // SUBMIT HANDLERS
        // --------------
        encapForm.addEventListener('submit', async function(event){
            try{
                await login();
                return false;
            }catch(error){
                uiHandleEncapError(error);
            }
        });


        // --------------
        // CLICK HANDLERS
        // --------------
        oneClickShowEid.addEventListener('click', function(){
            // Switch to e-ID form if the link has the eid attribute
            isOneClick = false;
            clearTimeout(refreshQrTimeout);
            uiToggleUserIdOneClick();
            return;
        });

        oneClickDeeplink.addEventListener('click', function(){
            // Stop refresh of qrId when opening the app
            clearTimeout(refreshQrTimeout);
            return;
        });

        oneClickAbort.addEventListener('click', function(event){
            // Reload the page to get a new QR id
            event.preventDefault();
            location.reload();
        });

        // In Paybutton
        if(paybuttons) {
            // let the approve button submit the PIN/TAN form
            qs('#btn_login_pintan', paybuttons).addEventListener('click', function(e){
                pinTanForm.submit();
            });

            // if page is not opened from app
            if(!location.href.includes('#encap-result')) {
                // show the Approve button in PIN/TAN tab
                qs('a[href="#ENCAP"]').addEventListener('click', async function(e) {
                    uiResetEidError();
                    paybuttonApprove.classList.add('hidden');
                    if (!cbs.qrId) {
                        newQrId = await CBSQrCode.fetchNewQrCode();
                        CBSQrCode.loadQr(newQrId.qrId, isFTN);
                    }
                    startWorkersPolling();
                    const qrResponse = await authQrIdRefresh();
                    // Update the authentication request code coming from the same endpoint as QR code
                    if(qrResponse?.status?.success && qrResponse.authenticationCode) {
                        uiHandleAuthCode(qrResponse.authenticationCode);
                    }
                    // ensure the auth code is visible in case the page is reloaded
                    // after erroneous creds are provided during pintan authentication
                    // and the user switches over to e-id authentication
                    oneclickAuthCodeWrapper.classList.remove('hidden');
                });
                qs('a[href="#PIN_TAN"]').addEventListener('click', async function(e) {
                    paybuttonApprove.classList.remove('hidden');
                    clearTimeout(refreshQrTimeout);
                    waitElement.classList.add('hidden');
                    uiResetEidError();
                });
            }
        }

        // --------------------
        // OTHER EVENT HANDLERS
        // --------------------

        // Start detecting when the user comes back from the app
        if(isMobile()) {
            document.addEventListener('visibilitychange', async function(event){
                if(isOneClick && (oneClickOnline) && 'visible' === document.visibilityState) {
                    requestAnimationFrame(docFocus);

                    function docFocus(){
                        if(!(document.hasFocus)){
                            return requestAnimationFrame(docFocus);
                        }

                        setTimeout(oneClickLogin(), 500); // https://discussions.apple.com/thread/254942697?sortBy=rank
                    }
                }
            });
        }
    });

    // Change text when user is switching between QR and Encap and vica versa
    function labelForQrButton(labelTxt) {
        switchBetweenQrAndEncapButton.innerHTML = labelTxt;
    }

    function createWorker() {
        worker = new Worker(workerUrl);
        workerCreated = true;
    }

    async function startWorkersPolling() {
        createWorker();
        worker.postMessage({functionName: 'pollQrVerification', url: cbs.contextPath , qrId:CBSQrCode.getQrIdFromInputField(), isFTN: isFTN});
        worker.onmessage = async (message) => {
            clearTimeout(refreshQrTimeout);
            await verifyWorkerMessage(message)
        }
    }

    function verifyWorkerResponse(message) {
        const qrVerified = message.data?.success && message.data?.response?.verified;

        // Replace document with backend provided html markup.
        if(!qrVerified && typeof message.data?.response === "string"){
            return {
                success: false,
                error: message.data?.response,
                documentReplace: true
            };
        }
        // Show backend provided error message or generic error message.
        if(!qrVerified || !message.data){
            return {
                success: false,
                error: message.data?.response?.status?.errors
                    && Array.isArray(message.data?.response.status.errors)
                    && message.data?.response.status.errors.shift()
            };
        }

        return { success: true };

    }

    async function oneClickLogin(){
        createWorker();
        oneClickButtons.classList.add('hidden');
        uiShowEidWaitingProcess();

        try{
            // Start polling QR verification
            worker.postMessage({functionName: 'pollQrVerification', url: cbs.contextPath , qrId:CBSQrCode.getQrIdFromInputField(), isFTN: isFTN});
            worker.onmessage = async (message) => {
                terminateWebWorker();
                clearTimeout(refreshQrTimeout);
                await verifyWorkerMessage(message)
            }
        }catch(error){
            uiHandleEncapError(error);
        }
    }

    async function verifyWorkerMessage(message) {
        try {
            let workerVerificationResult = verifyWorkerResponse(message);
            if (!(workerVerificationResult?.success)) {
                handleResponseError(workerVerificationResult);
                return;
            }

            qrCodeTemplate.classList.add('hidden');
            closeQrDialog();
            uiInitAuthCodeElements(useridAuthCodeWrapper);
            uiShowEidWaitingProcess();
            uiResetEidError();
            await login();
        } catch(error){
            uiHandleEncapError(error);
        }
    }

    async function login(){
        if(!isOneClick || !oneClickOnline) uiShowEidWaitingProcess();

        // Authenticate providing user id
        let authStartResponse;
        if(!isOneClick || !oneClickOnline) {
            authStartResponse = await postLoginForm();
            if(typeof authStartResponse === 'text') CBSFetchUtils.documentReplace(authStartResponse);
            if(!authStartResponse
                || !authStartResponse.success
                || (isFTN && !authStartResponse.ticketId)) {
                handleResponseError( {
                    success: false,
                    error: authStartResponse?.error
                });
                return;
            }
        }

        // for one-click, auth code is already in the markup
        if(!isOneClick || !oneClickOnline) uiHandleAuthCode(authStartResponse.authenticationCode);
        createWorker();
        worker.postMessage({
            functionName: 'pollLogin', qrId: CBSQrCode.getQrIdFromInputField(), isFTN: isFTN, isOneClick: isOneClick,
            oneClickOnline: oneClickOnline, encodedEncapForm: CBSFetchUtils.formUrlEncoded(encapForm),
            contextPath: cbs.contextPath, csrfKey: csrfKey, csrfValue: csrfValue
        });

        worker.onmessage = async (message) => {
            try {
                verifiedResult  = await verifyPollingWorkerResponse(message.data.response);
                terminateWebWorker();
                clearTimeout(refreshQrTimeout);
                // ticketId is only used in FTN
                const ticketId = isFTN
                    ? isOneClick
                        ? (verifiedResult.response.ticketId)
                        : authStartResponse.ticketId
                    : null;

                if (verifiedResult.success) {
                    // In Netbank & Paybutton
                    if(!isFTN) {
                        createSessionRedirect();
                        return;
                    }

                    // In FTN
                    ticketLogin(cbs.contextPath, ticketId, handleResponseError);
                    return;
                }else{
                    handleResponseError(verifiedResult);
                    return;
                }
            } catch (error) {
                uiHandleEncapError(error);
            }
        };
    }

    async function verifyPollingWorkerResponse(loginResult) {
        const loginSuccess = loginResult?.success && loginResult.processStatus === "COMPLETE";
        // Redirect the user if it's not allowed to view the result
        if(loginResult?.error === "USER_RESTRICTED") {
            location.href = cbs.redirectUrl;
        }

        // Replace document with backend provided html markup.
        if(!loginSuccess && typeof loginResult === "string"){
            return {
                success: false,
                error: loginResult,
                documentReplace: true
            };
        }
        // Show backend provided error message or generic error message.
        if(!loginSuccess || !loginResult){
            return {
                success: false,
                error: loginResult?.error
            };
        }

        return {
            success: true,
            response: loginResult
        }

    }

    function timeoutForAuthQrIdRefresh() {
        refreshQrTimeout = setTimeout(async () => {
            newQrId = await CBSQrCode.authQrIdRefresh();
            CBSQrCode.loadQr(newQrId.qrId, isFTN);
            if(newQrId?.status?.success && newQrId.authenticationCode) {
                uiHandleAuthCode(newQrId.authenticationCode);
            }
            timeoutForAuthQrIdRefresh();
        },20000);
    }

    // Terminate worker if created
    function terminateWebWorker() {
        if (workerCreated) {
            worker.terminate();
            workerCreated = false;
        }
    }

    function createSessionRedirect() {
        clearTimeout(refreshQrTimeout);
        qs("#encap-redirect-form").submit();
    }

    // UI functions
    async function uiInit(){
        // ----------------
        // Generic behavior
        // ----------------
        // If the page is a response to a Paybutton pintan request, show the approve button
        if(paybuttons && qs('#PIN_TAN').getAttribute('style') === 'display: flex;') paybuttonApprove.classList.remove('hidden');

        terminateWebWorker();

        // Reset all possibly ongoing polling
        clearTimeout(refreshQrTimeout);

        if (!isMobile()) {
            newQrId = await CBSQrCode.fetchNewQrCode();
            CBSQrCode.loadQr(newQrId.qrId, isFTN);
            uiResetEidError();
        }

        // ---------------
        // Mobile behavior
        // ---------------
        if(isOneClick && oneClickOnline) {
            // If the ABF app opens this page in a browser as a result of an encap auth for TPP,
            // only show message for customer to switch back to TPP manually
            if(location.href.includes('#encap-result')) {
                return uiSwitchBackMessageShow();
            }

            // Set the download link
            uiDownloadLinkSetup();

            // In Paybutton page, use the text on the Approve button
            // and show the back to merchant link
            if(paybuttons){
                timeoutForAuthQrIdRefresh();
                uiPaybuttonSetup();
            }

            // Prepare OneClick with
            // - callback attribute to workaround iOS "Open last tab" issue
            // - userAgent attribute to determine in what client the the page is opened
            // Only show the one click button in browsers or web views opened by ABF/ABS app
            uiInitAuthCodeElements(oneclickAuthCodeWrapper);
            uiOneClickButtonSetup();

            return;
        }

        // ----------------------------
        // Desktop and user id behavior
        // ----------------------------
        uiToggleUserIdOneClick();

        // UI functions internal to init
        function uiPaybuttonSetup() {
            oneClickDeeplink.innerText = qs('button', paybuttons).innerText.trim();
            qs('a', paybuttons).classList.remove('hidden');
        }

        function uiSwitchBackMessageShow() {
            const switchBackMessage = qs('#switchBack');
            switchBackMessage.classList.remove('hidden');
            qs('#ENCAP').replaceChildren(switchBackMessage.cloneNode(true));
            qs('#PIN_TAN').replaceChildren(switchBackMessage.cloneNode(true));

            if (paybuttons) {
                paybuttons.classList.add('hidden');
            }
            // In Netbank, set the language selection href to #encap-result to show the same message in the other language
            if (isNetbank) {
                for(option of document.querySelectorAll('.locale-picker > select > option')) {
                    option.value += '#encap-result';
                };
            }
            return;
        }

        function uiDownloadLinkSetup() {
            const downloadLink = document.querySelector('.app2app_download_info a');
            const linkAddress = agent.includes('android')
                ? 'https://play.google.com/store/apps/details?id=com.alandsbanken.mobilbank.fi'
                : (agent.includes('iphone') ? 'https://apps.apple.com/se/app/%C3%A5landsbanken-finland/id1052113446' : '');
            downloadLink.href = linkAddress;
        }

        function uiOneClickButtonSetup() {
            const isBrowser = !(
                agent.includes('wv') ||
                ((agent.includes('ipad') || agent.includes('iphone')) && !agent.includes('safari'))
            );

            if(isBrowser || isAbfWebview) {
                const encodedHref = encodeURIComponent(location.href);
                oneClickDeeplink.href +=
                    `&callback=${encodedHref}&userAgent=${encodeURIComponent(agent)}`;
                oneClickButtons.classList.remove('hidden');
                return;
            }

            eIdFields.classList.remove('hidden');
        }
    }

    // UI functions global to cbs-encap.js
    function uiToggleUserIdOneClick(){
        if(eIdFields.classList.contains('hidden')) {
            eIdFields.classList.remove('hidden');
            oneClickButtons.classList.add('hidden');
            uidInput.focus();
            uiInitAuthCodeElements(useridAuthCodeWrapper);
            return;
        }

        eIdFields.classList.add('hidden');
        oneClickButtons.classList.remove('hidden');
        paybuttons.children('button').classList.add('hidden');
    }

    function uiInitAuthCodeElements(container) {
        authCodeEl = container.querySelector('.authentication-code');
        authCodeInfo = qs('.authentication-code-oneclick .authentication-code-info');
        if(isOneClick && authCodeEl.innerHTML !== ''){
            oneclickAuthCodeWrapper.classList.remove('hidden');
            authCodeInfo.classList.remove('hidden');
        }
    }

    function uiShowEidWaitingProcess() {
        // Don't show the abort button for iPhone in Paybutton/FTN as reload will load Netbank login
        if(detectDeviceType() === 'android' || (detectDeviceType() === 'iphone' && isNetbank)) oneClickAbort.classList.remove('hidden');
        waitElement.classList.remove('hidden');
        processElement.classList.remove('hidden');
        encapForm.classList.add('hidden');

        if(!isOneClick || !oneClickOnline) {
            authCodeEl.innerHTML = '...';
            useridAuthCodeWrapper.classList.remove('hidden');
            authCodeInfo.classList.remove('hidden');
        }
    }

    function uiHandleAuthCode(authenticationCode) {
        if(authenticationCode) {
            authCodeEl = document.querySelectorAll('.authentication-code');
            authCodeEl.forEach(function(e) {
                e.innerHTML = authenticationCode
            });
        }
    }

    function uiHandleEncapError(error) {
        waitElement.classList.add('hidden');
        processElement.classList.add('hidden');
        encapForm.classList.remove('hidden');

        // Look for a matching error label
        let errorLabel = error?.message;
        if (error?.message in cbs.labels) {
            errorLabel = cbs.labels[error.message];
        }
        errorElement.innerHTML = error?.name === 'response' && errorLabel || cbs.labels.err_unexpected_error;

        errorElement.classList.remove('hidden');
        // Don't show the abort button for iPhone in Paybutton/FTN as reload will load Netbank login
        if(detectDeviceType() === 'android' || (detectDeviceType() === 'iphone' && isNetbank)) oneClickAbort.classList.remove('hidden');
        eIdFields.classList.add('has-error');
        if(uidLabel) uidLabel.classList.add('has-error');
        uidInput.classList.add('is-invalid');
        uidInput.setAttribute("aria-invalid", "true");
        useridAuthCodeWrapper.classList.add('hidden');
        oneclickAuthCodeWrapper.classList.add('hidden');
        authCodeInfo?.classList.add('hidden');
    }

    function uiResetEidError(){
        errorElement.classList.add('hidden');
        errorElement.innerHTML = '';
        eIdFields.classList.remove('has-error');
        // uidLabel not available in all authentications
        if(uidLabel) uidLabel.classList.remove('has-error');
        uidInput.classList.remove('is-invalid');
        uidInput.removeAttribute("aria-invalid");
    }

    async function postLoginForm() {
        const body = CBSFetchUtils.formUrlEncoded(encapForm);
        const url = encapForm.getAttribute('action');
        const request = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body
        });

        const response = await CBSFetchUtils.requestResponseBody(request);

        return response;
    }

    async function authQrIdRefresh(){
        try {
            const response = await CBSQrCode.authQrIdRefresh();
            const qrId = response?.status?.success && response.qrId;
            // Also reset the code used in AJAX requests
            cbs.qrId = qrId;

            // Set the QR code in the one-click button href
            const href = oneClickDeeplink.href && oneClickDeeplink.href.replace(/qrCode=[NETBANK]*[A-Z|0-9]*/, `qrCode=${qrId}`);
            oneClickDeeplink.href = href;

            return response;

        }catch(error){
            uiHandleEncapError(error);
        }
    }

    // Generic functions
    function handleResponseError(result) {
        if(!result || !result.error)  throw new Error();
        if(result && result.documentReplace) {
            CBSFetchUtils.documentReplace(result.error);
            return;
        }

        const error = new Error(result.error);
        error.name = 'response';
        throw error;
    }

    function isMobile() {
        const agent = navigator.userAgent.toLowerCase();
        return agent.includes('mobile') && (
            agent.includes('android')
            || agent.includes('iphone')
        );
    }

    function detectDeviceType(){
        const agent = navigator.userAgent.toLowerCase();
        const matchAndroid = agent.includes('android') && 'android';
        const matchIphone = agent.includes('iphone') && 'iphone';

        return matchAndroid || matchIphone || 'other';
    }

    function detectWebview(){
        const agent = navigator.userAgent.toLowerCase();
        const matchGeneric = agent.includes('wv');
        const matchApple = !agent.includes('safari') && (agent.includes('ipad') || agent.includes('iphone'));

        return !!(matchGeneric || matchApple || false);
    }

    function encapSelectedTab() {
        return (tabs.classList.contains('selected') && tabs.getAttribute('href') === '#ENCAP');
    }

    function qs(selector, container = document) {
        // TODO: cache also elements for containers
        let element = qsCache[selector];
        if(element) return element;

        element = container.querySelector(selector);
        if(element) qsCache[selector] = element;
        return element;
    }

    function qrDialogSetup() {
        qrCodeDialog.dialog({
            autoOpen: false,
            modal: true,
            width: 700,             // fixed pixel width
            height: 700,
            maxWidth: '700px',
            maxHeight: '700px',
            closeOnEscape: true,
            draggable: false,
            resizable: false,
            open: function() {
                $('.ui-widget-overlay').bind('click', closeQrDialog);
                qrDialogButton.addEventListener('click', closeQrDialog);
                qrDialogButton.addEventListener('keydown', closeQrDialogWithEnter);
            }
        });
        qrCodeButton.addEventListener('click', openQrDialog);
        qrCodeButton.addEventListener('keydown', openQrDialogWithEnter);
    }

    function openQrDialog(event) {
        event.preventDefault();
        qrCodeDialog.dialog('open');
    }

    function openQrDialogWithEnter(event) {
        if (!event.key.includes('Enter')) {
            return;
        }
        event.preventDefault();
        qrCodeDialog.dialog('open');
    }

    function closeQrDialog() {
        if(qrCodeDialog.dialog('isOpen')) {
            qrCodeDialog.dialog('close');
        }
    }

    function closeQrDialogWithEnter(event) {
        if (!event.key.includes('Enter')) {
            return;
        }
        event.preventDefault();
        if(qrCodeDialog.dialog('isOpen')) {
            qrCodeDialog.dialog('close');
        }
    }

    function qrZoomSetup() {
        let currentScale = 1; // Start at normal size
        const scaleStep = 0.2; // Scaling increments by 0.2 per zoom change
        const maxScale = 1.5; // Maximum scale limit
        const minScale = 1; // Prevent shrinking
        let lastZoomLevel = window.devicePixelRatio;

        function scaleImage() {
            if (!qrImage) return;
            const newZoomLevel = window.devicePixelRatio;
            if (newZoomLevel > lastZoomLevel && currentScale < maxScale) {
                currentScale = Math.min(currentScale + scaleStep, maxScale); // Increase scale gradually
            } else if (newZoomLevel < lastZoomLevel && currentScale > minScale) {
                currentScale = Math.max(currentScale - scaleStep, minScale); // Decrease scale gradually
            }

            if (qrCodeDialog.dialog('isOpen')) {
                adjustDialogScale();
            } else {
                // Enforce the max scale limit when zoom level exceeds 175% (devicePixelRatio >= 1.75)
                // Toggle fixed position to maintain focus
                if (currentScale > minScale && newZoomLevel > 1.5) {
                    qrImage.addClass('qr-image-zoomed');
                    qrImage.css("transform","scale(" + currentScale + ")");
                    qrCodeButton.removeEventListener('click', openQrDialog);
                } else {
                    qrImage.removeClass('qr-image-zoomed');
                    qrImage.css("transform","scale(1)");
                    qrCodeButton.addEventListener('click', openQrDialog);
                }
            }

            lastZoomLevel = newZoomLevel;
        }
        // Run scaling on resize & page load
        window.addEventListener("resize", scaleImage);
        window.addEventListener("load", scaleImage);

        // Monitor zoom changes dynamically
        setInterval(() => {
            if (window.devicePixelRatio !== lastZoomLevel) {
                scaleImage();
            }
        }, 500);
    }

    function adjustDialogScale() {
        const $dialog = $(".ui-dialog");

        const zoomLevel = window.outerWidth / window.innerWidth;

        $dialog.css({
            width: "700px",
            height: "700px",
            transformOrigin: "center center",
            position: "fixed",
            left: "50%",
            top: "50%",
            zIndex: "99999",
            marginLeft: "-350px", // half of original width
            marginTop: "-350px"   // half of original height
        });

        if (zoomLevel > 1) {
            // When zoomed in, scale it down to stay square visually
            const scale = 1 / zoomLevel;

            $dialog.css({
                transform: `scale(${scale})`,
            });
        } else {
            // Normal zoom or zoomed out: show full-size dialog
            $dialog.css({
                transform: "scale(1)",
            });
        }
    }
}());
