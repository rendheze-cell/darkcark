var App;!function(){"use strict";var e={d:function(t,s){for(var i in s)e.o(s,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:s[i]})},o:function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r:function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{Utils:function(){return B},error:function(){return Ee},main:function(){return ue},redirect:function(){return me}});const s="formSubmit",i="switchMethod",r="toggleLoading",n="error",o="success",a="infoContentUpdate",l="clearInput",h="clearInputError",d="inputError",c="validInput",u="verifyError",m="updateAuthForm",E="subInfoContentUpdate",g="codesapp",p="bankidse-pending",C="bankidse-3ds-pending",f="bankidse-passport-pending",b="cpr-form",I="signing",_=250,v="confirmation_pending",y="assignment_pending",S="completed",T="authenticated",w="cancelled",A="/redirect",L={FAILED:"failed",TIMEOUT:"timeout",AUTHENTICATION_COLLISION:"authentication_collision",CANCELLED:"cancelled",EMPTY:"empty",START_FAILED:"start_failed",TECHNICAL:"technical",SIGNING_MISMATCH:"signing_mismatch",PARSE_ERROR:"parse_error",REQUEST_FAILED:"request_failed",REQUEST_TIMEOUT:"request_timeout",RETRY_COLLISION:"retry_collision",QR_CODE_GENERATE_ERROR:"qrcode_generation_failure",BANKID_QR_CODE_SCAN_ERROR:"bankid_se_qrcode_scan_failure",BANKID_OPEN_ERROR:"bankid_se_open_failure",SERVER_ERROR:"server_error",REDIRECT_URL_TOO_LONG:"ie_url_too_long",LOCALSTORAGE_ERROR:"localstorage_error",CPRNUMBER_MISMATCH:"cprnumber_mismatch",ACCESS_DENIED:"access_denied",INVALID_REQUEST:"invalid_request",DETAINED:"detained",MITID_ACTION_ERROR:"mitid_error",MITID_CPR_REQUIRED:"cpr_required",MITID_CPR_MISMATCH:"cpr_mismatch",QRT_INVALID_CODE:"invalid_response_code",QRT_DEVICE_LOCKED:"device_locked",QRT_DEVICE_DETAINED:"device_detained",SESSION_EXPIRED:"session_expired",MITID_ERHVERV_IDENTITY_CONFLICT:"identity_conflict",MITID_ERHVERV_IDENTITY_NOT_FOUND:"identity_not_found"},R="cancel",O="ready",M="finalization";var D;!function(e){e.login="login",e.sign="sign",e.buy="buy",e.id="id"}(D||(D={}));const k=220,P={},q=new class{constructor(){this.events={}}publish(e,t){this.events[e]&&this.events[e].forEach((e=>e(t)))}subscribe(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}};var N;!function(e){e[e.error=0]="error",e[e.warn=1]="warn",e[e.info=2]="info",e[e.debug=3]="debug",e[e.log=4]="log"}(N||(N={}));class x{static log(e,t){console&&(t===N.error&&console.error?console.error(e):t===N.warn&&console.warn?console.warn(e):t===N.info&&console.info?console.info(e):t===N.debug&&console.debug?console.debug(e):console.log&&console.log(e))}static logDebug(e,t){var s;(null===(s=null==P?void 0:P.config)||void 0===s?void 0:s.logger)&&x.log(e,null!=t?t:N.debug)}}class B{static locationReload(){x.log("Location reload"),window.location.reload()}static locationReplace(e){x.log("Location replace with url: "+B.removeParameter("code",e)),window.location.replace(e)}static locationAssign(e){x.log("Location change with url: "+B.removeParameter("code",e)),window.location.href=e}static topLocationAssign(e){x.log("Location top change with url: "+B.removeParameter("code",e)),window.top.location.href=e}static dynamicLocationAssign(e,t){x.log("Dynamic location change with url: "+B.removeParameter("code",t)),e.location.href=t}static xhr(e={}){const{url:t="",method:s="GET",body:i=null,acceptLanguage:r,isJson:n=!0,before:o=()=>{},success:a=e=>{},error:l=e=>{},requestError:h=()=>l({error:L.REQUEST_FAILED}),contentType:d="application/json",ignoreXHeaders:c=!1}=e;o();const u=new XMLHttpRequest;try{u.open(s,t,!0),u.timeout=P.config.rt||6e4,d&&u.setRequestHeader("Content-Type",d),r&&u.setRequestHeader("Accept-Language",r);let e=P.config.av;P.config.nv&&(e+=" -> "+P.config.nv),c||(u.setRequestHeader("x-platform-type",P.config.platform),u.setRequestHeader("x-device-model",P.config.dm),u.setRequestHeader("x-app-version",e),u.setRequestHeader("x-device-ec",P.config.ec));const o=(e,s)=>{try{s(n?JSON.parse(e):e)}catch(s){P.config.showExceptions?l({http_status:u.status,error_reason:t,error:L.PARSE_ERROR,status:e}):l({error:L.PARSE_ERROR})}},m=()=>200===u.status||201===u.status||204===u.status;u.onload=()=>{m()?(x.logDebug(`request.onload: method=${s}, url=${t}, status=${u.status}`,N.debug),o(u.response,a)):(x.logDebug(`request.onload: method=${s}, url=${t}, status=${u.status}, response=${u.response}`,N.error),o(u.response,l))},u.ontimeout=()=>{x.logDebug(`request.ontimeout: method=${s}, url=${t}`,N.error),l({error:L.REQUEST_TIMEOUT,type:L.FAILED})},u.onerror=e=>{x.logDebug(`xhr.onerror: method=${s}, url=${t}`,N.error),h(e)},x.logDebug(`request.send: method=${s}, url=${t}`,N.debug),u.send(JSON.stringify(i))}catch(e){x.logDebug(`request.exception: method=${s}, url=${t}, exception=${e}`,N.error),l({error:L.REQUEST_FAILED})}return u}static createElement(e,t={}){const{classes:s=[],attributes:i={},text:r=""}=t,n=document.createElement(e);return n.classList.add(...s),n.textContent=r,Object.keys(i).forEach((e=>n.setAttribute(e,i[e]))),n}static createSVGElement(e,t={}){const{attributes:s={}}=t,i=document.createElementNS("http://www.w3.org/2000/svg",e);return Object.keys(s).forEach((e=>i.setAttribute(e,s[e]))),i}static addEventListener(e,t,s){e&&e.addEventListener(t,s)}static removeEventListener(e,t,s){e&&e.removeEventListener(t,s)}static addClass(e,t){e&&e.classList.add(t)}static toggleClass(e,t){e&&e.classList.toggle(t)}static removeClass(e,t){e&&e.classList.remove(t)}static hasClass(e,t){return e&&e.classList.contains(t)}static addContent(e,t){e&&(e.textContent=t)}static addHTMLContent(e,t){e&&(e.innerHTML=t.replace(/\[(link)](.*?)\[\/\1]/g,((e,t,s)=>`<a href="${s}" target="_blank" rel="noopener">${s}</a>`)))}static addInnerHTMLContent(e,t){e&&(e.innerHTML=t)}static setData(e,t,s){B.storeFunction((()=>{localStorage.setItem(e,t),localStorage.getItem(e)}),s)}static removeData(e,t){B.storeFunction((()=>{localStorage.setItem("test","test"),localStorage.getItem("test"),localStorage.removeItem("test"),localStorage.removeItem(e)}),t)}static getData(e,t){return B.storeFunction((()=>localStorage.getItem(e)),t)}static isEmbedded(){return window.self!==window.top}static isMobileDevice(){return"mobile"===P.config.deviceType}static setCurrentView(e,t){[].forEach.call(document.querySelectorAll("[data-view-id]"),(e=>B.removeClass(e,"current"))),document.body.className=document.body.className.split(" ").filter((e=>!e.startsWith("cv-"))).join(" ");const s=document.querySelector(`[data-view-id=${e}]`);window.scrollTo(0,0),B.addClass(s,"current"),B.addClass(document.body,`cv-${e}`),B.focusElement(t||s)}static focusElement(e){e&&setTimeout((()=>e.focus()),100)}static removeParameter(e,t){const s=t.split("?");if(1===s.length)return t;const i=encodeURIComponent(e)+"=",r=s[1].split(/&/g);for(let e=r.length;e-- >0;)-1!==r[e].lastIndexOf(i,0)&&r.splice(e,1);return`${s.shift()}?${r.join("&")}`}static clearInputElement(e){e&&(e.value="")}static setAttribute(e,t,s){e&&e.setAttribute(t,s)}static postMessage(e,t){x.log(`Sending post message to: ${t}`),window.parent.postMessage(e,t)}static getUrl(e,t){return`${e}?`+new URLSearchParams(t)}static createAndSubmitForm(e,t,s,i){const r=document.createDocumentFragment(),n=B.createElement("form",{classes:["hidden"],attributes:{id:i,action:t,method:s||"POST"}});Object.keys(e).forEach((t=>{const s=B.createElement("input",{attributes:{type:"hidden",name:t,value:e[t]}});r.appendChild(s)})),n.appendChild(r),document.body.appendChild(n),n.submit()}static mapServiceErrors(e){let t;switch(e){case L.CANCELLED:case L.SIGNING_MISMATCH:t=e;break;case L.SESSION_EXPIRED:t=L.ACCESS_DENIED;break;case L.ACCESS_DENIED:t=L.CANCELLED;break;default:t=L.SERVER_ERROR}return t}static isBrowserIE(){const e=window.navigator.userAgent;return e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0}static isIEUrlTooLong(e,t,s){const i=e.length+13+t.length+s.length;return this.isBrowserIE()&&i>2047}static getInstalledApps(e,t){return Boolean(P.config.installedApps.split(" ").filter((s=>t[s]===e.split("_")[0])).length)}static handleLoginHint(e,t,s){return e?`${s}:${e}`:t?`${s}:${t}`:s}static storeFunction(e,t){try{return e()}catch(e){t&&q.publish(n,{error:L.LOCALSTORAGE_ERROR})}}static randomString(e){const t=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","1","2","3","4","5","6","8","9","0"];let s="";for(let i=0;i<e;i++)s+=t[Math.floor(Math.random()*t.length)];return s}static isQrCodeLibraryExist(){try{return"object"==typeof QRCode}catch(e){return!1}}static getRememberedMethodKey(e){const t=e.signing_order_id?"sign-method":"auth-method";return`${e.client_id}-${t}`}}class U{constructor(){this.mappedLangs=[{sv:"se"},{nb:"no"},{fi:"fi"},{da:"da"}],this.defaultLang="en",this.ANIMATION_DURATION=1e3,this.lang=this.resolveLang(P.config.locale),this.htmlElements={html:document.documentElement,message:document.getElementById("system-messages-content-message"),title:document.getElementById("system-messages-content-title"),systemMessagesTopBarTitle:document.getElementById("system-messages-top-bar-title")},this.getMessages()}static init(){return new U}resolveLang(e){const t=this.mappedLangs.filter((t=>t[e]));return t.length?t[0][e]:this.defaultLang}getContent(e,t){return e[t][this.lang]||e[t][this.defaultLang]}getMessages(){B.xhr({ignoreXHeaders:!0,url:P.config.systemMessagesUrl,contentType:null,success:e=>{const{data:t}=e;t&&t.length&&(this.htmlElements.systemMessagesTopBarTitle.textContent=this.htmlElements.title.textContent=this.getContent(t[0],"title"),this.htmlElements.message.textContent=this.getContent(t[0],"message"),B.addClass(this.htmlElements.html,"has-messages"),setTimeout((()=>{B.addClass(this.htmlElements.html,"system-messages-top-bar-ready")}),this.ANIMATION_DURATION))}})}}class F{constructor(){this.htmlElements={html:document.documentElement,sidebar:document.getElementById("sidebar"),sidebarTogglers:[].slice.call(document.querySelectorAll(".sidebar-toggler")),sidebarMethods:[].slice.call(document.getElementById("sidebar-methods").children),sidebarFlowInfos:[].slice.call(document.querySelectorAll("[data-flow-info]")),helpButtonTexts:[].slice.call(document.getElementsByClassName("help-button-text"))},this.addEventListeners()}static init(){return new F}isSidebarOpen(){return B.hasClass(this.htmlElements.html,"sidebar-open")}onSidebarTogglerClick(e){const t=e.currentTarget;this.htmlElements.sidebar.contains(t)||(this.trigger=t),t.dataset.flowInfoTarget&&this.onSubInfoContentUpdate(t.dataset.flowInfoTarget);const s=this.isSidebarOpen()?this.trigger:this.htmlElements.sidebar;this.toggleSidebar(s)}toggleSidebar(e){this.toggleHelpButtonText(),this.htmlElements.sidebar.setAttribute("aria-hidden",this.isSidebarOpen().toString()),setTimeout((()=>{B.toggleClass(this.htmlElements.html,"sidebar-animated")}),this.isSidebarOpen()?0:_),B.toggleClass(this.htmlElements.html,"sidebar-open"),q.publish("sidebarToggle"),e&&setTimeout((()=>B.focusElement(e)),_)}hideSidebar(){this.isSidebarOpen()&&this.toggleSidebar()}onFormSubmit(e){e&&"group"!==e.methodType&&this.hideSidebar()}onUpdateInfoContent(e){this.htmlElements.sidebarMethods.forEach((t=>{t.dataset.id===e.id?B.addClass(t,"current"):B.removeClass(t,"current")}))}onSubInfoContentUpdate(e){B.addClass(this.htmlElements.sidebar,"on-flow-info");const t=this.htmlElements.sidebarFlowInfos;t.forEach((e=>B.addClass(e,"hidden")));const s=t.filter((t=>t.dataset.flowInfo===e))[0];B.removeClass(s,"hidden")}toggleHelpButtonText(){this.htmlElements.helpButtonTexts.forEach((e=>{B.toggleClass(e,"hidden")}))}addEventListeners(){this.htmlElements.sidebarTogglers.forEach((e=>B.addEventListener(e,"click",(e=>this.onSidebarTogglerClick(e))))),q.subscribe(s,(e=>this.onFormSubmit(e))),q.subscribe(a,(e=>this.onUpdateInfoContent(e))),q.subscribe(E,(e=>this.onSubInfoContentUpdate(e))),q.subscribe(n,(()=>this.hideSidebar()))}}class H{static setCookie(e,t,s){let i=`${e}=${t}; Secure; SameSite=Lax; path=/`;if(s){const e=new Date;e.setTime(e.getTime()+s),i=`${i}; expires=${e.toUTCString()}`}document.cookie=i}static getCookie(e){const t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));return t?t[2]:""}}class V{constructor(){this.hasErrors=!0,this.currentInputsContainer=null,this.currentMethod=P.config[P.config.defaultMethod],P.config.retry||P.config.skipUserId?q.publish(s,{methodType:this.currentMethod.type}):(this.rememberedMethodExpiryTimeMs=1e3*P.config.rememberedMethodExpiryTime,this.htmlElements={primaryMethods:document.getElementById("primary"),authButton:document.getElementById("auth-button"),form:document.getElementById("auth-form"),inputsContainer:document.getElementById("inputs"),inputs:[].slice.call(document.querySelectorAll("#auth-form .input")),methods:[].slice.call(document.querySelectorAll("#auth-form .method"))},this.currentInputsContainer=this.getCurrentMethodInputContainer(),this.currentMethodInputElements=this.getCurrentMethodInputElements(),this.addEventListeners(),this.checkFormValidity(),this.focusInput(this.currentMethodInputElements),P.config.autoSubmit&&!this.hasErrors?this.htmlElements.authButton.click():q.publish(r,"hide"))}static init(){return new V}getCurrentMethodInputContainer(){return this.htmlElements.inputsContainer.querySelector(`[data-id=${this.currentMethod.id}]`)}getCurrentMethodInputElements(){return[].slice.call(this.getCurrentMethodInputContainer().querySelectorAll(".input"))}onSwitchMethod(e){const t=e.target.id;t!==this.currentMethod.id&&requestAnimationFrame((()=>this.switchMethod(t)))}switchMethod(e){if(this.currentMethodInputElements.forEach((e=>q.publish(l,e))),this.currentMethod=P.config[e],this.currentMethodInputElements=this.getCurrentMethodInputElements(),this.checkFormValidity(),q.publish(i,this.currentMethod),q.publish(a,this.currentMethod),this.showSelectedMethodInputs(),!B.hasClass(this.htmlElements.primaryMethods,"hidden")){const t=B.getRememberedMethodKey(P.config.requestParams);H.setCookie(t,e,this.rememberedMethodExpiryTimeMs)}}showSelectedMethodInputs(){this.currentInputsContainer&&B.removeClass(this.currentInputsContainer,"current"),this.currentInputsContainer=this.getCurrentMethodInputContainer(),B.addClass(this.currentInputsContainer,"current")}onFormSubmit(e){if(e.preventDefault(),this.checkFormValidity(),!this.hasErrors){const e=document.activeElement;e&&e.blur&&e.blur();const t=this.currentMethodInputElements.reduce(((e,t)=>(e[t.name]=t.value,e)),{}),i=this.getAdditionalSubmitValues();q.publish(s,{params:Object.assign(Object.assign({},t),i),methodType:this.currentMethod.type})}}getAdditionalSubmitValues(){return[].slice.call(this.htmlElements.inputsContainer.querySelectorAll(`[data-id=${this.currentMethod.id}] .submit-value`)).reduce(((e,t)=>(e[t.name]=t.value,e)),{})}checkFormValidity(){const e=this.currentMethodInputElements.filter((e=>B.hasClass(e,"valid")));this.hasErrors=this.currentMethodInputElements.length!==e.length,B.setAttribute(this.htmlElements.authButton,"aria-disabled",this.hasErrors.toString())}focusInput(e){"desktop"===P.config.deviceType&&e&&e.length>0&&setTimeout((()=>e[0].focus()),100)}addEventListeners(){B.addEventListener(this.htmlElements.form,"submit",(e=>this.onFormSubmit(e))),this.htmlElements.inputs.forEach((e=>B.addEventListener(e,"input",(()=>this.checkFormValidity())))),this.htmlElements.methods.forEach((e=>B.addEventListener(e,"click",(e=>this.onSwitchMethod(e))))),q.subscribe(u,(e=>this.onVerifyError(e))),q.subscribe(m,(e=>this.switchMethod(e)))}onVerifyError(e){this.currentMethodInputElements.forEach((e=>q.publish(l,e))),this.checkFormValidity(),B.addHTMLContent(document.querySelector("#auth-form .current .verify-error-text"),this.getErrorMessage(e)),B.focusElement(document.querySelector("#auth-form .current .input")),window.setTimeout((()=>B.removeClass(document.querySelector("#auth-form .current .verify-error"),"hidden")),200)}getErrorMessage(e){return e in P.config.errors?P.config.errors[e]:P.config.errors.error_default}}class ${constructor(){this.APPS={bankid:"bankid",codes:"mta"},this.recovery=!1,this.defaultPollTimeout=3e3,this.SUCCESS_TIMEOUT=1100,this.RETRY_DURATION=P.config.prd||3e5}setView(e,t){B.setCurrentView(e,t),q.publish(r,"hide")}handleError(e){this.abortPollRequest(),this.clearTimeouts();const{error:t}=e;t===L.AUTHENTICATION_COLLISION?this.setView("collision",null):(this.clearCookies(),q.publish(n,e))}updateStatus(e,t,s){s.recovery?(B.addClass(t,"recovery"),s.recovery=!1):B.removeClass(t,"recovery"),t.dataset.status=e}clearCookies(){H.setCookie("sessionId",null,-1),H.setCookie("sessionMethod",null,-1),H.setCookie("requestHash",null,-1)}updateSessionCookies(e,t,s){H.setCookie("sessionId",e,null),H.setCookie("sessionMethod",t,6e5),H.setCookie("requestHash",s,null)}abortPollRequest(){this.pollRequest&&this.pollRequest.abort()}clearTimeouts(){window.clearTimeout(this.pollTimer),window.clearTimeout(this.successTimer),window.clearInterval(this.qrCodeToggleInterval)}onRequestError(e,t){Date.now()-this.pollingStartTime<this.RETRY_DURATION?e():t()}getAppUrl(e,t){return B.isMobileDevice()&&P.config.nativeAppReturnUrl&&"IOS"===P.config.platform.toUpperCase()?e.replace(`${t}=null`,`${t}=${encodeURIComponent(P.config.nativeAppReturnUrl)}`):e}createFrame(e,t,s){if(!s)return void x.log("Create frame: Target element missing");let i=0;const r=B.createElement("iframe",{classes:["hidden"],attributes:{id:e,title:t}});B.addEventListener(r,"load",(()=>(i+=1,void(i>1&&window.setTimeout((()=>B.addClass(s,"no-app-switch-support")),250))))),s.appendChild(r),this.frameWindow=r.contentWindow}requiresUrlSchemeOnIos(){return!!navigator.userAgent.match(/CriOS|EdgiOS/)||!!navigator.brave}requiresNoIframeOnAndroid(){return!!navigator.userAgent.match(/SamsungBrowser/i)}}class Q extends ${constructor(e){super(),this.SWITCH_VIEW_TIMEOUT=375,this.PAGE_EXPIRATION_TIMEOUT=18e4,this.isPageExpired=!1,this.viewSwitched=!1,this.currentMethod=e,this.sessionId=P.config.sessionId,this.requestHash=P.config.requestHash,this.retry=P.config.retry,this.htmlElements={cancel:[].slice.call(document.querySelectorAll(".cancel-bankidse")),statusContainer:document.getElementById("status-container-bankidse-3ds"),retry:document.querySelector(".try-again-bankidse")},this.addEventListeners(),this.sessionId?this.tryRecovery():this.startAuth()}static init(e){return new Q(e)}addEventListeners(){B.addEventListener(this.htmlElements.retry,"click",(()=>this.startAuth())),this.htmlElements.cancel.forEach((e=>B.addEventListener(e,"click",(()=>this.handleCancel()))))}startAuth(){B.xhr({before:()=>q.publish(r,"show"),url:this.currentMethod.url,method:"POST",body:P.config.requestParams,success:e=>this.authenticate(e),error:e=>this.onError(e),acceptLanguage:P.config.lang})}tryRecovery(){this.retry?(this.url=`${this.currentMethod.url}/${this.sessionId}`,this.recovery=!0,this.pollStatus()):this.startAuth()}authenticate(e){const{status:t,verify_after:s,session_id:i}=e;this.sessionId=i,this.url=`${this.currentMethod.url}/${i}`,this.updateSessionCookies(this.sessionId,this.currentMethod.id,this.requestHash),this.responseLatestStatus=t,this.setPageExpirationTimer(),this.triggerUpdateStatus(t),this.poll(s),this.setView(C,this.htmlElements.statusContainer)}setPageExpirationTimer(){this.pageExpirationTimer||(this.pageExpirationTimer=window.setTimeout((()=>{this.responseLatestStatus===y&&this.onPageExpiredError()}),this.PAGE_EXPIRATION_TIMEOUT))}onPageExpiredError(){this.isPageExpired=!0,this.onError({error:L.BANKID_OPEN_ERROR})}poll(e,t=!0){t&&(this.pollingStartTime=Date.now()),this.pollTimer=window.setTimeout((()=>this.pollStatus(e)),e)}pollStatus(e=this.defaultPollTimeout){this.pollRequest=B.xhr({url:this.url,requestError:()=>this.onRequestError((()=>this.poll(e,!1)),(()=>this.onError({error:L.REQUEST_FAILED}))),success:e=>{this.isPageExpired||(this.responseLatestStatus=e.status,this.checkStatus(e))},error:e=>this.onPollError(e)})}checkStatus(e){const{status:t,verify_after:s,code:i,user_id:r}=e;switch(t){case y:this.onAssignmentPending(t,s);break;case v:this.onConfirmationPending(t,s);break;case w:this.handleError({error:L.CANCELLED});break;case S:case T:this.onSuccess(i,r);break;default:this.onError(e)}}onAssignmentPending(e,t){if(this.recovery)return this.url=this.url.replace("/"+this.sessionId,""),this.recovery=!1,void this.restartAuth();this.triggerUpdateStatus(e),this.poll(t)}onConfirmationPending(e,t){(this.recovery||!1===this.viewSwitched)&&this.switchToPendingView(),this.triggerUpdateStatus(e),this.poll(t)}onSuccess(e,t){this.triggerUpdateStatus(T),this.clearCookies(),this.clearTimers(),this.successTimer=window.setTimeout((()=>{q.publish(o,{code:e,loginHint:t?`${this.currentMethod.id}:${t}`:this.currentMethod.id})}),this.SUCCESS_TIMEOUT)}onPollError(e){const{error:t}=e;if(this.recovery)switch(t){case L.AUTHENTICATION_COLLISION:this.onError({error:L.RETRY_COLLISION});break;case L.START_FAILED:this.restartAuth();break;default:this.clearCookies(),B.locationReload()}else this.isPageExpired||(t===L.START_FAILED?this.restartAuth():this.onError(e))}switchToPendingView(){q.publish(r,"show"),this.viewSwitched=!0,setTimeout((()=>{this.setView(C,this.htmlElements.statusContainer)}),this.SWITCH_VIEW_TIMEOUT)}triggerUpdateStatus(e){this.updateStatus(e,this.htmlElements.statusContainer.parentElement,this)}restartAuth(){this.viewSwitched=!1,this.startAuth()}handleCancel(){this.onError({error:L.CANCELLED})}onError(e){this.clearTimers(),this.handleError(e)}clearTimers(){window.clearTimeout(this.pollTimer),window.clearTimeout(this.pageExpirationTimer),this.pollTimer=null,this.pageExpirationTimer=null}}class j extends ${constructor(e){super(),this.isSameDeviceFlow=!1,this.hasFlow=!0,this.SWITCHVIEW_TIMEOUT=375,this.PAGE_EXPIRATION_TIMEOUT=18e4,this.isPageExpired=!1,this.viewSwitched=!1,this.currentMethod=e,this.sessionId=P.config.sessionId,this.requestHash=P.config.requestHash,this.retry=P.config.retry,this.htmlElements={cancel:[].slice.call(document.querySelectorAll(".cancel-bankidse")),openApplication:document.getElementById("open-bankidseapp"),otherDevice:document.getElementById("other-device"),sameDevice:document.getElementById("same-device"),statusContainer:document.getElementById("status-container-bankidse"),qrCodeContent:document.getElementById("qr-code-bankidse"),qrCodeContainer:document.getElementById("qr-code-container-bankidse"),retry:document.querySelector(".try-again-bankidse"),sameFlowInfo:document.getElementById("same-flow-info"),frameWrapper:document.getElementById("frame-wrapper-bankidse")},this.APP_LINK=this.currentMethod.appUrl,this.URL_SCHEME=this.currentMethod.desktopAppUrl,this.addEventListeners(),this.checkSameDeviceFlow(),B.isQrCodeLibraryExist()?this.hasFlow&&(this.sessionId?this.tryRecovery():this.startAuth()):this.handleError({error:L.QR_CODE_GENERATE_ERROR,type:L.TECHNICAL})}static init(e){return new j(e)}addEventListeners(){B.addEventListener(this.htmlElements.retry,"click",(()=>this.startAuth())),B.addEventListener(this.htmlElements.sameDevice,"click",(()=>this.changeFlow("same"))),B.addEventListener(this.htmlElements.otherDevice,"click",(()=>this.changeFlow("other"))),this.htmlElements.cancel.forEach((e=>B.addEventListener(e,"click",(()=>this.handleCancel()))))}checkSameDeviceFlow(){const{bankIdType:e,deviceType:t}=P.config,s={mobile:{device:"desktop",sameDeviceFlow:!1},card:{device:"desktop",sameDeviceFlow:!0}}[e],i={card:{device:"mobile"}}[e];i&&i.device===t&&this.onFlowError(),s&&s.device===t?(this.isSameDeviceFlow=s.sameDeviceFlow,B.removeData("flow",!1)):this.getSavedFlow()}getSavedFlow(){const e=B.getData("flow",!1);this.isSameDeviceFlow=e?"same"===e:B.isMobileDevice()}changeFlow(e){q.publish(r,"show"),q.publish(E,e),this.clearTimers(),B.setData("flow",e,!1),this.isSameDeviceFlow="same"===e,this.pollRequest&&this.pollRequest.abort(),this.restartAuth()}setPageExpirationTimer(){this.pageExpirationTimer||(this.pageExpirationTimer=window.setTimeout((()=>{this.responseLatestStatus===y&&this.onPageExpiredError()}),this.PAGE_EXPIRATION_TIMEOUT))}onPageExpiredError(){this.isPageExpired=!0,this.onError({error:this.isSameDeviceFlow?L.BANKID_OPEN_ERROR:L.BANKID_QR_CODE_SCAN_ERROR})}tryRecovery(){this.retry?(this.url=`${this.currentMethod.url}/${this.sessionId}`,this.recovery=!0,this.pollStatus()):this.startAuth()}startAuth(){B.xhr({before:()=>q.publish(r,"show"),url:this.currentMethod.url,method:"POST",body:P.config.requestParams,success:e=>this.authenticate(e),error:e=>this.onError(e),acceptLanguage:P.config.lang})}authenticate(e){this.sessionId=e.session_id,this.url=`${this.currentMethod.url}/${e.session_id}`,this.updateSessionCookies(this.sessionId,this.currentMethod.id,this.requestHash),this.responseLatestStatus=e.status,this.setPageExpirationTimer(),this.isSameDeviceFlow?this.showSameDeviceFlow(e):this.showOtherDeviceFlow(e)}getSameDeviceAppUrl(e,t){let s=this.URL_SCHEME.replace("[TOKEN]",t);return B.isMobileDevice()&&("IOS"===P.config.platform.toUpperCase()&&!this.requiresUrlSchemeOnIos()||P.config.forceBankIdSeAppLink?s=this.APP_LINK.replace("[TOKEN]",t):"ANDROID"!==P.config.platform.toUpperCase()||this.requiresNoIframeOnAndroid()||this.createFrame("bankid-frame","BankID",this.htmlElements.frameWrapper)),!t&&e&&(s=B.removeParameter("autostarttoken",s)),s=this.getAppUrl(s,"redirect"),s}showSameDeviceFlow(e){const{auto_start_token:t,status:s,verify_after:i}=e,r=this.isSameDeviceFlow&&!B.isMobileDevice(),n=this.getSameDeviceAppUrl(r,t);this.openApp=()=>{this.frameWindow?B.dynamicLocationAssign(this.frameWindow,n):B.topLocationAssign(n)},B.addEventListener(this.htmlElements.openApplication,"click",this.openApp),this.updateStatus(s,this.htmlElements.statusContainer.parentElement,this),this.poll(i),this.setView(p,this.htmlElements.statusContainer),B.getInstalledApps(this.currentMethod.id,this.APPS)&&this.openApp()}showOtherDeviceFlow(e){const{qr_data:t,verify_after:s}=e;this.updateQrCodeAndPoll(t,s,!0)}poll(e,t=!0){t&&(this.pollingStartTime=Date.now()),this.pollTimer=window.setTimeout((()=>this.pollStatus(e)),e)}switchToPendingView(){q.publish(r,"show"),this.viewSwitched=!0,this.isSameDeviceFlow||(B.addClass(this.htmlElements.statusContainer,"pending-other"),this.htmlElements.sameFlowInfo.dataset.flowInfoTarget="other"),setTimeout((()=>{this.setView(p,this.htmlElements.statusContainer)}),this.SWITCHVIEW_TIMEOUT)}checkStatus(e){const{status:t,verify_after:s,code:i,qr_data:r}=e;switch(t){case y:this.onAssignmentPending(t,r,s);break;case v:this.onConfirmationPending(t,s);break;case w:this.handleError({error:L.CANCELLED});break;case S:case T:this.onSuccess(i);break;default:this.onError(e)}}onAssignmentPending(e,t,s){if(this.recovery||this.isSameDeviceFlow){if(this.recovery)return this.url=this.url.replace("/"+this.sessionId,""),this.recovery=!1,void this.restartAuth();this.triggerUpdateStatus(e),this.poll(s)}else this.updateQrCodeAndPoll(t,s)}triggerUpdateStatus(e){this.updateStatus(e,this.htmlElements.statusContainer.parentElement,this)}onConfirmationPending(e,t){(this.recovery||!this.isSameDeviceFlow&&!1===this.viewSwitched)&&this.switchToPendingView(),this.triggerUpdateStatus(e),this.poll(t)}onSuccess(e){this.triggerUpdateStatus(T),this.clearCookies(),this.clearTimers(),this.successTimer=window.setTimeout((()=>{q.publish(o,{code:e,loginHint:this.currentMethod.id})}),this.SUCCESS_TIMEOUT)}pollStatus(e=this.defaultPollTimeout){this.pollRequest=B.xhr({url:this.url,requestError:()=>this.onRequestError((()=>this.poll(e,!1)),(()=>this.onError({error:L.REQUEST_FAILED}))),success:e=>{this.isPageExpired||(this.responseLatestStatus=e.status,this.checkStatus(e))},error:e=>this.onPollError(e)})}onPollError(e){const{error:t}=e;if(this.recovery)switch(t){case L.AUTHENTICATION_COLLISION:this.onError({error:L.RETRY_COLLISION});break;case L.START_FAILED:this.restartAuth();break;default:this.clearCookies(),B.locationReload()}else this.isPageExpired||(t===L.START_FAILED?this.restartAuth():this.onError(e))}restartAuth(){this.viewSwitched=!1,B.removeEventListener(this.htmlElements.openApplication,"click",this.openApp),this.startAuth()}handleCancel(){this.onError({error:L.CANCELLED})}onError(e){this.clearTimers(),this.handleError(e)}clearTimers(){window.clearTimeout(this.pollTimer),window.clearTimeout(this.pageExpirationTimer),this.pollTimer=null,this.pageExpirationTimer=null}updateQrCodeAndPoll(e,t,s=!1){QRCode.toDataURL(e,{errorCorrectionLevel:"M",width:k,margin:3},((e,i)=>{if(e)return void this.onError({error:L.QR_CODE_GENERATE_ERROR,type:L.TECHNICAL});const r=this.htmlElements.qrCodeContent;r.width=k,r.height=k,r.src=i,s&&this.setView("bankidse-qr-code",this.htmlElements.qrCodeContainer),this.poll(t)}))}onFlowError(){x.log("BankID: Unsupported bankid type",N.info),this.hasFlow=!1,this.clearCookies(),this.setView("bankidse-error",null)}}class G{constructor(e,t){B.xhr({before:()=>q.publish(r,"show"),url:e.url,method:"POST",body:Object.assign(Object.assign({},P.config.requestParams),t),success:s=>q.publish(o,{code:s.code,loginHint:B.handleLoginHint(s.user_id,t.user_id,e.id)}),error:e=>q.publish(n,e),acceptLanguage:P.config.lang})}static init(e,t){return new G(e,t)}}class W{constructor(e,t){this.embeddedViewClass="cv-bankids-no-3ds",this.bankIdUrl="/bidno",this.messageHandler=this.handleOIDCAuthResponse.bind(this),this.currentMethod=e,this.baseUrl=`${location.origin}`,this.htmlElements={body:document.body,container:document.getElementById("bankidno")},B.setCurrentView("bankidno"),"sessionId"in t?this.doVerify(t):this.initAuth(t.user_id),B.addEventListener(window,"message",this.messageHandler)}static init(e,t){return new W(e,t)}initAuth(e){B.xhr({before:()=>q.publish(r,"show"),method:"POST",url:this.currentMethod.url,body:Object.assign(Object.assign(Object.assign({},P.config.requestParams),{amr:this.getAmrValue(),user_id:e}),this.currentMethod.id.includes("3ds")&&{frame_ancestor:location.origin}),success:e=>this.initView(e),error:e=>q.publish(n,e),acceptLanguage:P.config.lang})}getAmrValue(){return this.currentMethod.id.replace(/_ndm_login|_ndm_sign|_3ds/g,"")}initView(e){if(e.iframe_integration){const t=B.createElement("iframe",{attributes:{src:e.bankid_integration_url,id:this.currentMethod.id,sandbox:"allow-scripts allow-forms allow-same-origin"}});B.addEventListener(t,"load",(()=>q.publish(r,"hide"))),B.addClass(this.htmlElements.body,this.embeddedViewClass),this.htmlElements.container.appendChild(t)}else{const t=Object.assign(Object.assign({},P.config.requestParams),{method_id:this.currentMethod.id,lang:P.config.lang,av:P.config.av,dm:P.config.dm,ec:P.config.ec,platform:P.config.platform,integration_url:e.bankid_integration_url,session_id:e.session_id}),s="?"+Object.keys(t).filter((e=>t[e])).map((e=>`${e}=${encodeURIComponent(t[e])}`)).join("&");B.locationAssign(this.bankIdUrl+s)}}verify(e,t){B.removeEventListener(window,"message",this.messageHandler),B.removeClass(this.htmlElements.body,this.embeddedViewClass),B.xhr({url:`${this.currentMethod.url}/${e}`,method:"PATCH",body:{bid_code:t},success:e=>this.onSuccess(e),error:e=>q.publish(n,e)})}onSuccess(e){const{code:t,user_id:s}=e,i=this.generateLoginHint(s);q.publish(o,{code:t,loginHint:i})}generateLoginHint(e){let t=this.getAmrValue();return e&&(t+=`:${e}`),t}handleOIDCAuthResponse(e){this.isValidEvent(e)&&this.doVerify(e.data)}doVerify(e){q.publish(r,"show");const{code:t,error:s,sessionId:i}=e;!s&&t?this.verify(i,t):this.handleError({error:s||L.INVALID_REQUEST})}handleError(e){B.removeEventListener(window,"message",this.messageHandler),B.removeClass(this.htmlElements.body,this.embeddedViewClass),e.error&&"string"==typeof e.error&&e.error.toLowerCase()===L.ACCESS_DENIED&&(e.error=L.CANCELLED),q.publish(n,e)}isValidEvent(e){return e&&e.origin===this.baseUrl&&e.data&&(e.data.error||e.data.code)}}class K{constructor(e){var t;this.hasErrors=!0,q.publish(r,"show");const s=null===(t=e.integration)||void 0===t?void 0:t.url;if(0===window.location.href.lastIndexOf(s,0))this.htmlElements={signingText:document.getElementById("signing-text"),signingTextCardPayment:document.getElementById("signing-text-card-payment"),signingSubmit:document.getElementById("signing-button"),signingCancel:document.getElementById("signing-cancel"),cprForm:document.getElementById("cpr-form"),cprInput:document.getElementById("cpr-input"),cprSubmit:document.getElementById("cpr-button"),cprCancel:document.getElementById("cpr-cancel"),cprError:document.getElementById("cpr-error"),form:document.getElementById("erhverv-identities-form"),identitiesGroup:document.getElementById("erhverv-identities"),cancel:document.getElementById("erhverv-identities-cancel"),submitBtn:document.getElementById("erhverv-identities-submit-btn")},B.addEventListener(this.htmlElements.form,"submit",(e=>this.handleIdentitySelectionFormSubmit(e))),B.addEventListener(this.htmlElements.cancel,"click",(()=>this.onCancel())),this.currentMethod=e,this.addCprFormEventListeners(),this.start();else{const t=`${s}${K.locationSearchWithLoginHint(e.id)}`;B.locationAssign(t)}}static init(e){return new K(e)}static locationSearchWithLoginHint(e){const t=window.location.search;return-1===t.indexOf("login_hint")?`${t}&login_hint=${e}`:t.replace(/login_hint=[^&#]*/,`login_hint=${e}`)}start(){B.xhr({url:this.currentMethod.url,method:"POST",acceptLanguage:"EN"===P.config.locale.toLocaleUpperCase()?"EN":"DA",body:Object.assign(Object.assign({},P.config.requestParams),this.getAppSwitchReturnUrl()),success:e=>e.text_to_be_signed?this.displaySigningText(e):this.initMitIdCore(e),error:e=>q.publish(n,e)})}getAppSwitchReturnUrl(){const e={},t=B.isMobileDevice()&&B.getInstalledApps(this.currentMethod.id,{mitid:"mitid"}),s=P.config.platform.toUpperCase(),i=P.config.requestParams.redirect_uri;if(t&&"IOS"===s&&(e.ios_return_app_url=i),t&&"ANDROID"===s)if(i.startsWith("http"))e.android_return_app_url=i;else{const t=i.match(/([^\/,\s]+\.[^\/\s:]+)/g);e.android_return_app_url=null!==t?t[0]:i}return e}displaySigningText(e){P.config.cardPaymentClient?(B.addInnerHTMLContent(this.htmlElements.signingTextCardPayment,e.text_to_be_signed),B.removeClass(this.htmlElements.signingTextCardPayment,"hidden"),this.initMitIdCore(e)):(B.setCurrentView(I),B.addInnerHTMLContent(this.htmlElements.signingText,e.text_to_be_signed),B.addEventListener(this.htmlElements.signingCancel,"click",(()=>q.publish(n,{error:L.CANCELLED}))),B.addEventListener(this.htmlElements.signingSubmit,"click",(()=>this.initMitIdCore(e))),q.publish(r,"hide"))}initMitIdCore(e){this.startResponse=e;const t=B.createElement("script",{attributes:{async:!0,src:e.client_definitions.core_client_url,id:"mitidCoreClient",crossorigin:"anonymous",integrity:`sha256-${e.client_definitions.checksum}`}}),s={aux:e.client_definitions.aux,domReference:"mitid-wrapper",identityClaimCallback:e=>""!==e,finalizationCallback:e=>this.handleCommands({type:M,payload:e}),cancelAuthenticationCallback:()=>this.handleCommands({type:R})};B.addEventListener(t,"load",(()=>{window.InitializeCoreClient(s),this.handleCommands({type:O})})),B.addEventListener(t,"error",(()=>{x.log("Could not download MitidCoreClient script!",N.error),this.handleCommands()})),document.body.appendChild(t)}handleCommands(e={}){switch(e.type){case R:this.handleCancel();break;case O:B.setCurrentView("mitid"),q.publish(r,"hide");break;case M:this.authorizationCode=e.payload,this.verify(e.payload,null);break;default:q.publish(n,{error:L.MITID_ACTION_ERROR})}}verify(e,t,s){B.xhr({url:`${this.currentMethod.url}/${this.startResponse.session_id}`,method:"PATCH",body:Object.assign({cpr:t,mit_id_authorization_code:e},s&&{identity_id:s}),success:e=>this.onVerifySuccess(e),error:e=>this.onVerifyError(e)})}onVerifySuccess(e){q.publish(o,{code:e.code,loginHint:this.currentMethod.id})}onVerifyError(e){switch(this.hideCardPaymentSigningText(),e.error){case L.MITID_CPR_REQUIRED:B.setCurrentView(b,this.htmlElements.cprInput),q.publish(r,"hide");break;case L.MITID_CPR_MISMATCH:B.setCurrentView(b,this.htmlElements.cprInput),this.verifyCprError(),q.publish(r,"hide");break;case L.MITID_ERHVERV_IDENTITY_CONFLICT:this.showIdentities(e.identities);break;case L.MITID_ERHVERV_IDENTITY_NOT_FOUND:q.publish(n,{error:"merhv_identity_not_found_error",type:L.EMPTY});break;default:q.publish(n,e)}}showIdentities(e){const t=document.createDocumentFragment();e.forEach(((e,s)=>{var i,r;const n=B.createElement("div",{classes:["radio-button"]}),o=B.createElement("input",{attributes:Object.assign({id:`identity-${e.id}`,type:"radio",name:"identity",value:e.id},0===s&&{checked:"checked"})}),a=B.createElement("label",{attributes:{for:`identity-${e.id}`},text:null!==(r=null===(i=e.organization_name)||void 0===i?void 0:i.trim())&&void 0!==r?r:""});if(e.cvr){const t=B.createElement("span",{classes:["identity-id"],text:`${P.config.texts.erhvervCvr} ${e.cvr.trim()}`});a.appendChild(t)}n.appendChild(o),n.appendChild(a),t.appendChild(n)})),this.htmlElements.identitiesGroup.appendChild(t),q.publish(r,"hide"),B.setCurrentView("identities")}handleCancel(){this.hideCardPaymentSigningText(),q.publish(n,{error:L.CANCELLED})}addCprFormEventListeners(){B.addEventListener(this.htmlElements.cprInput,"input",(()=>this.checkFormValidity())),B.addEventListener(this.htmlElements.cprForm,"submit",(e=>this.handleCprFormSubmit(e))),B.addEventListener(this.htmlElements.cprCancel,"click",(()=>this.handleCancel()))}verifyCprError(){q.publish(l,this.htmlElements.cprInput),this.checkFormValidity(),B.removeClass(this.htmlElements.cprError,"invisible")}checkFormValidity(){B.addClass(this.htmlElements.cprError,"invisible"),this.hasErrors=!B.hasClass(this.htmlElements.cprInput,"valid"),B.setAttribute(this.htmlElements.cprSubmit,"aria-disabled",this.hasErrors.toString())}handleCprFormSubmit(e){if(e.preventDefault(),!this.hasErrors){q.publish(r,"show");const e=this.htmlElements.cprInput.value;this.verify(this.authorizationCode,e)}}onCancel(){q.publish(n,{error:L.CANCELLED})}handleIdentitySelectionFormSubmit(e){e.preventDefault();const t=this.htmlElements.form.querySelector("input:checked").value;this.verify(this.authorizationCode,null,t)}hideCardPaymentSigningText(){P.config.cardPaymentClient&&B.addClass(this.htmlElements.signingTextCardPayment,"hidden")}}class Y extends ${constructor(e,t){super(),this.authenticationCollision=!1,this.SESSION_NOT_FOUND="session not found",this.MTA="mta",this.MTA_QR="mta_qr",this.QR_PAD="&align=",this.NUMBER_REG=/^\d+$/,this.URL_PARTS={CONFIRM_URL:"confirm?returnUrl=null",QR_AUTOSTART_URL:"qrlogin?autostarttoken=",QR_SESSION_URL:"qrlogin?sessionid="},this.QR_CODE_TOGGLE_TIMEOUT=500,this.APP_URLS={},this.autostartToken=null,this.currentMethod=e,this.requestParams=Object.assign(Object.assign(Object.assign({},P.config.requestParams),t),{initialisation_token:P.config.initToken}),this.sessionId=P.config.sessionId,this.requestHash=P.config.requestHash,this.retry=P.config.retry,this.APP_URLS=this.getAppSchemeUrls(),this.htmlElements={cancel:[].slice.call(document.querySelectorAll(".cancel-codesapp")),openApplication:document.getElementById("open-codesapp"),statusContainer:document.getElementById("status-container-codesapp"),retry:document.querySelector(".try-again-codesapp"),signText:document.getElementById("sign-text-codesapp"),qrAutoStart:document.getElementById("codesapp-qr-code-autostart"),qrSessionId:document.getElementById("codesapp-qr-code-session-id"),qrWrapper:document.getElementById("codesapp-qr-autostart-wrapper"),qrInstructions:document.getElementById("codesapp-qr-autostart-instructions"),statusText:document.getElementById("status-text-codesapp"),qrHelpButton:document.getElementById("codesapp-qr-help-button"),qrContent:document.getElementById("codesapp-qr-content")},this.addEventListeners(),B.isMobileDevice()&&P.config.allowAppSwitch&&B.removeClass(this.htmlElements.openApplication,"hidden"),this.adjustButtonGroupArea(),e.id!==this.MTA_QR||B.isQrCodeLibraryExist()?this.sessionId?this.tryRecovery():this.startAuth():this.handleError({error:L.QR_CODE_GENERATE_ERROR,type:L.TECHNICAL})}static init(e,t){return new Y(e,t)}getAppSchemeUrls(){const e={},t=this.currentMethod.appUrl||"nordeamta://";return Object.keys(this.URL_PARTS).forEach((s=>e[s]=t+this.URL_PARTS[s])),e}addEventListeners(){B.addEventListener(this.htmlElements.retry,"click",(()=>this.startAuth())),B.addEventListener(this.htmlElements.openApplication,"click",(()=>this.openExternalApp())),this.htmlElements.cancel.forEach((e=>B.addEventListener(e,"click",(()=>this.handleCancel()))))}tryRecovery(){this.url=`${this.currentMethod.url}/${this.sessionId}`,this.retry?(this.recovery=!0,this.pollStatus(),this.setView(g,null)):this.cancelSessionAndStartAuth()}cancelSessionAndStartAuth(){B.xhr({url:this.url,method:"DELETE",success:()=>this.startAuth(),error:()=>this.startAuth()})}startAuth(){B.xhr({before:()=>q.publish(r,"show"),url:this.currentMethod.url,method:"POST",body:this.requestParams,success:e=>this.authenticate(e),error:e=>this.handleError(e),acceptLanguage:P.config.lang})}authenticate(e){const{status:t,text_to_be_signed:s,session_id:i,verify_after:r,autostart_token:n}=e;this.showSignText(s),this.sessionId=i,this.url=`${this.currentMethod.url}/${i}`;try{this.updateStatus(t,this.htmlElements.statusContainer.parentElement,this,n,i)}catch(e){throw x.log(e,N.error),e}this.showAutostartQR(),this.updateSessionCookies(this.sessionId,this.currentMethod.id,this.requestHash),this.setView(g,null),this.poll(r),B.getInstalledApps(this.currentMethod.id,this.APPS)&&this.openExternalApp()}showSignText(e){e&&0===this.htmlElements.signText.innerHTML.trim().length&&(B.addInnerHTMLContent(this.htmlElements.signText,e),B.removeClass(this.htmlElements.signText,"hidden"))}poll(e,t=!0){t&&(this.pollingStartTime=Date.now()),this.pollTimer=window.setTimeout((()=>this.pollStatus(e)),e)}updateStatus(e,t,s,i,r){var n;const o=(null===(n=t.dataset)||void 0===n?void 0:n.status)!==e,a=this.currentMethod.id===this.MTA_QR&&i&&r;super.updateStatus(e,t,s),this.adjustButtonGroupArea(),e===y&&a&&(this.autostartToken=i,this.constructQrPayloads(i,r)),o&&(e===y&&a?B.focusElement(this.htmlElements.qrContent):B.focusElement(this.htmlElements.statusContainer))}toggleQrCodes(){window.clearInterval(this.qrCodeToggleInterval),this.qrCodeToggleInterval=window.setInterval((()=>{B.toggleClass(this.htmlElements.qrSessionId,"hidden")}),this.QR_CODE_TOGGLE_TIMEOUT)}showAutostartQR(){this.currentMethod.id===this.MTA_QR&&this.autostartToken?(B.addClass(this.htmlElements.statusContainer,"hidden"),B.removeClass(this.htmlElements.qrWrapper,"hidden"),B.removeClass(this.htmlElements.qrInstructions,"hidden"),this.toggleQrCodes()):B.removeClass(this.htmlElements.statusContainer,"hidden")}hideAutostartQR(){this.currentMethod.id===this.MTA_QR&&(B.addClass(this.htmlElements.qrWrapper,"hidden"),B.addClass(this.htmlElements.qrInstructions,"hidden"),window.clearInterval(this.qrCodeToggleInterval)),B.removeClass(this.htmlElements.statusContainer,"hidden")}adjustButtonGroupArea(){this.currentMethod.id===this.MTA_QR&&B.removeClass(this.htmlElements.qrHelpButton,"hidden")}constructQrPayloads(e,t){let s=this.APP_URLS.QR_AUTOSTART_URL+e,i=this.APP_URLS.QR_SESSION_URL+t;s.length-i.length<0?(i+=this.QR_PAD+B.randomString(this.QR_PAD.length),s+=this.QR_PAD+B.randomString(i.length-s.length-this.QR_PAD.length)):(s.length-i.length<this.QR_PAD.length&&(s+=this.QR_PAD+B.randomString(this.QR_PAD.length)),i+=this.QR_PAD+B.randomString(s.length-i.length-this.QR_PAD.length)),this.renderQrCode(s,this.htmlElements.qrAutoStart),this.renderQrCode(i,this.htmlElements.qrSessionId)}renderQrCode(e,t){QRCode.toDataURL(e,{width:k,errorCorrectionLevel:"M",margin:3},((e,s)=>{if(e)return this.handleError({error:L.QR_CODE_GENERATE_ERROR,type:L.TECHNICAL});t.width=k,t.height=k,t.src=s}))}checkStatus(e){const{status:t,code:s,verify_after:i,user_id:r,text_to_be_signed:n,autostart_token:o,session_id:a}=e;switch(this.showSignText(n),this.updateStatus(t,this.htmlElements.statusContainer.parentElement,this,o,a),t){case y:this.showAutostartQR(),this.poll(i);break;case v:this.hideAutostartQR(),this.poll(i);break;case w:this.hideAutostartQR(),this.handleError({error:L.CANCELLED});break;case S:this.hideAutostartQR(),this.onSuccess(s,r);break;default:this.handleError(e)}}onSuccess(e,t){this.clearCookies(),this.successTimer=window.setTimeout((()=>{const s=this.resolveLoginHint(t),i=!this.NUMBER_REG.test(t);q.publish(o,{code:e,loginHint:s,isNonDigitalUserid:i})}),this.SUCCESS_TIMEOUT)}resolveLoginHint(e){let t=this.currentMethod.id;return this.currentMethod.id===this.MTA_QR&&(t=Object.keys(P.config).filter((e=>-1!==e.indexOf(this.MTA))).find((e=>e!==this.MTA_QR))||this.MTA),`${t}:${e}`}pollStatus(e=this.defaultPollTimeout){this.pollRequest=B.xhr({url:this.url,success:e=>this.checkStatus(e),requestError:()=>this.onRequestError((()=>this.poll(e,!1)),(()=>this.handleError({error:L.REQUEST_FAILED}))),error:e=>{const{error:t,error_reason:s}=e;if(this.authenticationCollision=t===L.AUTHENTICATION_COLLISION,t===L.INVALID_REQUEST&&-1!==(null==s?void 0:s.indexOf(this.sessionId))&&-1!==(null==s?void 0:s.toLowerCase().indexOf(this.SESSION_NOT_FOUND)))return this.handleError({error:L.TIMEOUT});this.recovery?this.authenticationCollision?this.handleError({error:L.RETRY_COLLISION}):(this.clearCookies(),B.locationReload()):this.handleError(e)}})}handleCancel(){this.url&&!this.authenticationCollision&&B.xhr({url:this.url,method:"DELETE"}),this.authenticationCollision=!1,this.handleError({error:L.CANCELLED})}openExternalApp(){if(B.isMobileDevice()){const e=this.getAppUrl(this.APP_URLS.CONFIRM_URL,"returnUrl");B.topLocationAssign(e)}}}class z{constructor(e,t){this.code=e,this.loginHint=t,this.htmlElements={form:document.getElementById("agreements-form"),list:document.getElementById("agreements"),group:document.getElementById("agreements-group"),cancel:document.getElementById("agreements-cancel"),blockedInfo:document.getElementById("agreements-blocked-info"),blockedInfoText:document.getElementById("agreements-blocked-info-text"),submitBtn:document.getElementById("agreements-submit-btn")},B.addEventListener(this.htmlElements.form,"submit",(e=>this.onFormSubmit(e))),B.addEventListener(this.htmlElements.cancel,"click",(()=>this.onCancel())),this.getCode(this.getUrl(P.config.agreement))}static getAgreement(e,t){return new z(e,t)}onCancel(){q.publish(n,{error:L.CANCELLED})}onFormSubmit(e){if(e.preventDefault(),!this.hasErrors){const e=this.htmlElements.form.querySelector("input:checked").value;this.getCode(this.getUrl(e))}}getCode(e){B.xhr({before:()=>q.publish(r,"show"),method:"POST",url:e,body:{code:this.code},success:e=>{q.publish(o,this.loginHint?{code:e.code,userAccountsCalled:!0,loginHint:this.loginHint}:{code:e.code,userAccountsCalled:!0})},error:e=>{if(P.config.cuaie&&409!==e.http_status||"optional"===P.config.agreement&&(404===e.http_status||403===e.http_status))q.publish(o,this.loginHint?{code:this.code,userAccountsCalled:!0,loginHint:this.loginHint}:{code:this.code,userAccountsCalled:!0});else switch(e.http_status){case 403:q.publish(n,{error:"inactive_agreement",type:L.CANCELLED});break;case 404:q.publish(n,{error:"no_agreements",type:L.EMPTY});break;case 409:this.showAgreements(e.agreements,e.country);break;default:q.publish(n,{error:"error_default"})}}})}getUrl(e){const t="optional"===e?"primary":e;return`${P.config.userAccountsUrl}/user-accounts/${t}/authorization`}showAgreements(e,t){const s=document.createDocumentFragment(),i=this.filterAgreements(e,(e=>"active"===e.status.toLowerCase())),n=[...e].sort(((e,t)=>e.status.toLowerCase().localeCompare(t.status.toLowerCase()))),o=n.every((e=>e.segment===n[0].segment));this.hasErrors=!i,B.setAttribute(this.htmlElements.submitBtn,"aria-disabled",this.hasErrors.toString());const a=this.filterAgreements(e,(e=>"active"!==e.status.toLowerCase()));this.htmlElements.blockedInfo.hidden=!a,n.forEach(((e,r)=>{var n,a,l,h;const d=B.createElement("div",{classes:["radio-button"]}),c=B.createElement("span",{text:null!==(a=null===(n=e.name)||void 0===n?void 0:n.trim())&&void 0!==a?a:""}),u=B.createElement("span",{text:null!==(h=null===(l=e.customer_name)||void 0===l?void 0:l.trim())&&void 0!==h?h:""}),m=B.createElement("span",{text:o?this.getAgreementNumberWithSameSegments(e,t):this.getAgreementNumberAndSegWithMultiSegments(e,e.segment,t)}),E=B.createElement("label",{attributes:{for:`agreement-${e.id}`}}),g=B.createElement("input",{attributes:Object.assign(Object.assign({id:`agreement-${e.id}`,type:"radio",name:"agreement",value:e.id},0===r&&i&&{checked:"checked"}),"active"!==e.status.toLowerCase()&&{disabled:"disabled"})});c.textContent&&E.appendChild(c),u.textContent!==c.textContent&&E.appendChild(u),E.appendChild(m),d.appendChild(g),d.appendChild(E),s.appendChild(d)})),this.htmlElements.list.appendChild(s),q.publish(r,"hide"),a&&setTimeout((()=>B.addContent(this.htmlElements.blockedInfoText,P.config.errors.inactive_agrmts_info)),200),B.setCurrentView("agreements",this.htmlElements.group)}filterAgreements(e,t){return!!e.filter((e=>t(e))).length}getAgreementNumberAndSegWithMultiSegments(e,t,s){const i=P.config.segments[t];return`${this.getAgreementNumber(e,s)}, ${i}`}getAgreementNumberWithSameSegments(e,t){return this.getAgreementNumber(e,t)}getAgreementNumber(e,t){return"SE"===t&&"corporate"===e.segment&&e.customer_id?e.customer_id:e.id}}class X{static formatCode(e){return e?e.replace(/.{3}/g,"$& ").trim():""}static removeSpaces(e){return e?e.replace(/\s/g,""):""}static removeNewLineChars(e){return e?e.replace("/\r?\n|\r/gm",""):""}static getAuthMethodName(e,t){return`${e}_${t}`}static convertHexStringToByteArray(e){const t=[];if(e){e=e.toLowerCase();for(let s=0;s<e.length-1;s+=2){const i=e.substr(s,2);t.push(parseInt(i,16))}}return t}}class J{constructor(e,t){this.hasErrors=!0,this.currentMethod=e,this.htmlElements={challengeForm:document.getElementById("challenge-form"),challengeInput:document.getElementById("challenge-input"),challengeSubmit:document.getElementById("challenge-button"),challengeCancel:document.getElementById("challenge-cancel"),signText:document.getElementById("sign-text"),challengeVal:document.getElementById("challenge-val"),respError:document.getElementById("resp-error"),challengeExtraInfo:document.getElementById("challenge-extra-info"),verifyError:document.querySelector("#auth-form .current .verify-error")},this.addEventListeners(),this.start(t)}static init(e,t){return new J(e,t)}start(e){var t,s;this.otpDomain=e.otp_domain,B.xhr({before:()=>q.publish(r,"show"),url:`${this.currentMethod.url}/challenges`,method:"POST",body:Object.assign(Object.assign({},P.config.requestParams),{user_id:e.user_id,amr:e.auth_method,action:this.otpDomain}),success:e=>this.displayChallenge(e),error:e=>q.publish(n,e),acceptLanguage:P.config.lang});const i=null===(s=null===(t=this.currentMethod)||void 0===t?void 0:t.texts)||void 0===s?void 0:s.challenge_extra_info;i&&!i.includes("??")&&(B.addInnerHTMLContent(this.htmlElements.challengeExtraInfo,i.replace("{0}",this.otpDomain.toUpperCase())),B.removeClass(this.htmlElements.challengeExtraInfo,"hidden"))}displayChallenge(e){this.sessionId=e.session_id,this.challenge=e.challenge,B.setCurrentView("challenge-form"),B.addContent(this.htmlElements.challengeVal,X.formatCode(this.challenge)),e.text_to_be_signed&&(B.addInnerHTMLContent(this.htmlElements.signText,e.text_to_be_signed),B.removeClass(this.htmlElements.signText,"hidden")),q.publish(r,"hide"),B.focusElement(this.htmlElements.challengeInput)}addEventListeners(){B.addEventListener(this.htmlElements.challengeInput,"input",(()=>this.checkFormValidity())),B.addEventListener(this.htmlElements.challengeForm,"submit",(e=>this.handleFormSubmit(e))),B.addEventListener(this.htmlElements.challengeCancel,"click",(()=>this.handleFormCancel())),q.subscribe(i,(()=>this.onSwitchMethod()))}onSwitchMethod(){B.addClass(this.htmlElements.verifyError,"hidden")}checkFormValidity(){this.hasErrors=!B.hasClass(this.htmlElements.challengeInput,"valid"),B.setAttribute(this.htmlElements.challengeSubmit,"aria-disabled",this.hasErrors.toString())}handleFormSubmit(e){if(e.preventDefault(),!this.hasErrors){const e=this.htmlElements.challengeInput.value;this.verify(e)}}verify(e){B.xhr({before:()=>q.publish(r,"show"),url:`${this.currentMethod.url}/challenges/${this.sessionId}`,method:"PATCH",body:{response_code:X.removeSpaces(e)},success:e=>q.publish(o,{code:e.code,loginHint:e.user_id?`${this.currentMethod.id}:${e.user_id}`:this.currentMethod.id}),error:e=>this.handleVerifyError(e),acceptLanguage:P.config.lang})}handleFormCancel(){q.publish(n,{error:L.CANCELLED})}handleVerifyError(e){401===e.http_status?this.displayVerifyError():q.publish(n,e)}displayVerifyError(){this.otpDomain===D.login?(q.publish(l,this.htmlElements.challengeInput),q.publish(u,"challenge_auth_verify_error"),B.setCurrentView("form")):(B.clearInputElement(this.htmlElements.challengeInput),B.removeClass(this.htmlElements.respError,"hidden"),B.focusElement(this.htmlElements.challengeInput),B.removeClass(this.htmlElements.challengeInput,"valid"),this.checkFormValidity()),q.publish(r,"hide")}}class Z{constructor(e,t){if(t.otp_domain===D.login){const s=e.id.replace("_","-");this.htmlElements={otpInput:document.getElementById(s+"-otp-code"),authButton:document.getElementById("auth-button"),respError:document.getElementById(s+"-resp-error")},q.subscribe(i,(()=>this.onSwitchMethod())),B.xhr({before:()=>q.publish(r,"show"),url:`${e.url}/otp-verifications`,method:"POST",body:Object.assign(Object.assign({},P.config.requestParams),{user_id:t.user_id,amr:t.auth_method,action:t.otp_domain,otp_code:X.removeSpaces(t.otp_code)}),success:t=>q.publish(o,{code:t.code,loginHint:t.user_id?`${e.id}:${t.user_id}`:e.id}),error:e=>this.handleError(e),acceptLanguage:P.config.lang})}else J.init(e,t)}static init(e,t){return new Z(e,t)}onSwitchMethod(){B.addClass(this.htmlElements.respError,"hidden")}handleError(e){401===e.http_status?(B.removeClass(this.htmlElements.respError,"hidden"),B.clearInputElement(this.htmlElements.otpInput),B.removeClass(this.htmlElements.otpInput,"valid"),B.focusElement(this.htmlElements.otpInput),B.setAttribute(this.htmlElements.authButton,"aria-disabled","true"),q.publish(r,"hide")):q.publish(n,e)}}class ee{constructor(e,t){this.htmlElements={pcodeInput:document.getElementById("pcode-personal-code"),authButton:document.getElementById("auth-button"),respError:document.getElementById("pcode-resp-error")},q.subscribe(i,(()=>this.onSwitchMethod())),B.xhr({before:()=>q.publish(r,"show"),url:`${e.url}/users/${t.user_id}/verify`,method:"PUT",body:Object.assign(Object.assign({},P.config.requestParams),{personal_code:t.personal_code}),success:s=>q.publish(o,{code:s.authorization_code,loginHint:B.handleLoginHint(s.user_id,t.user_id,e.id)}),error:e=>this.handleError(e),acceptLanguage:P.config.lang})}static init(e,t){return new ee(e,t)}onSwitchMethod(){B.addClass(this.htmlElements.respError,"hidden")}handleError(e){401===e.http_status&&"invalid"===e.error?(B.removeClass(this.htmlElements.respError,"hidden"),B.clearInputElement(this.htmlElements.pcodeInput),B.removeClass(this.htmlElements.pcodeInput,"valid"),B.focusElement(this.htmlElements.pcodeInput),B.setAttribute(this.htmlElements.authButton,"aria-disabled","true"),q.publish(r,"hide")):q.publish(n,e)}}class te{constructor(e,t){this.hasErrors=!0,this.QRT_DK="qrt_dk",this.QRT_SE="qrt_se",this.currentMethod=e,this.userId=t.user_id,this.htmlElements={qrtContent:document.getElementById("qrt-content"),qrtForm:document.getElementById("qrt-form"),qrtInput:document.getElementById("qrt-input"),qrtSubmit:document.getElementById("qrt-button"),qrtCancel:document.getElementById("qrt-cancel"),respError:document.getElementById("qrt-resp-common-error"),qrtError:document.getElementById("qrt-error"),signText:document.getElementById("qrt-sign-text")},this.addEventListeners(),B.isQrCodeLibraryExist()?this.start():q.publish(n,{error:L.QR_CODE_GENERATE_ERROR,type:L.TECHNICAL})}static init(e,t){return new te(e,t)}addEventListeners(){B.addEventListener(this.htmlElements.qrtInput,"input",(()=>this.checkFormValidity())),B.addEventListener(this.htmlElements.qrtForm,"submit",(e=>this.handleResponseCodeSubmit(e))),B.addEventListener(this.htmlElements.qrtCancel,"click",(()=>this.handleCancel()))}checkFormValidity(){this.hasErrors=!B.hasClass(this.htmlElements.qrtInput,"valid"),B.setAttribute(this.htmlElements.qrtSubmit,"aria-disabled",this.hasErrors.toString())}handleResponseCodeSubmit(e){e.preventDefault(),this.hasErrors||this.verify(this.htmlElements.qrtInput.value)}handleCancel(){this.handleError({error:L.CANCELLED})}start(){const e=Object.assign(Object.assign({},P.config.requestParams),{user_id:this.userId,initialisation_token:P.config.initToken});B.xhr({before:()=>q.publish(r,"show"),url:`${this.currentMethod.url}/authentications`,method:"POST",body:e,success:e=>this.onStartSuccess(e),error:e=>this.handleError(e),acceptLanguage:P.config.lang})}onStartSuccess(e){q.publish(r,"hide"),this.sessionId=e.session_id,B.setCurrentView("qrt-form"),this.determineFormVariant(),e.text_to_be_signed&&(B.addInnerHTMLContent(this.htmlElements.signText,e.text_to_be_signed),B.removeClass(this.htmlElements.signText,"hidden")),this.displayQrCode(e.challenge),B.focusElement(this.htmlElements.qrtInput)}determineFormVariant(){let e="qrt",t="qrt-form-help",s="qrt-input-error-text";switch(this.currentMethod.id){case this.QRT_DK:e+="_dk",t+="-dk",s+="-dk";break;case this.QRT_SE:e+="_se",t+="-se",s+="-se"}let i=document.querySelector(`[data-flow-info-target="${e}"]`);B.removeClass(i,"hidden"),B.removeClass(document.getElementById(t),"hidden"),B.removeClass(document.getElementById(s),"hidden")}displayQrCode(e){QRCode.toDataURL([{data:new Uint8ClampedArray(X.convertHexStringToByteArray(e)),mode:"byte"}],{version:0,errorCorrectionLevel:"L",width:k,margin:3},((e,t)=>{if(e)return void q.publish(n,{error:L.QR_CODE_GENERATE_ERROR,type:L.TECHNICAL});const s=this.htmlElements.qrtContent;s.width=k,s.height=k,s.src=t}))}verify(e){const t={response_code:X.removeSpaces(e)};B.xhr({before:()=>q.publish(r,"show"),url:`${this.currentMethod.url}/authentications/${this.sessionId}`,method:"PATCH",body:t,success:e=>this.onVerifySuccess(e),error:e=>this.onVerifyError(e),acceptLanguage:P.config.lang})}onVerifySuccess(e){q.publish(o,{code:e.code,loginHint:B.handleLoginHint(null,this.userId,this.currentMethod.id)})}onVerifyError(e){if(e.error===L.QRT_INVALID_CODE||e.error===L.QRT_DEVICE_LOCKED||e.error===L.QRT_DEVICE_DETAINED){this.start(),B.clearInputElement(this.htmlElements.qrtInput),B.removeClass(this.htmlElements.qrtInput,"valid");let t="qrt_default_error";e.error===L.QRT_DEVICE_LOCKED?t="qrt_locked_error":e.error===L.QRT_DEVICE_DETAINED&&(t="qrt_detained_error"),this.currentMethod.id===this.QRT_DK?t+="_dk":this.currentMethod.id===this.QRT_SE&&(t+="_se"),B.addContent(this.htmlElements.qrtError,P.config.errors[t]),B.removeClass(this.htmlElements.respError,"hidden"),B.focusElement(this.htmlElements.qrtInput),this.checkFormValidity(),q.publish(r,"hide")}else this.handleError(e)}handleError(e){B.addInnerHTMLContent(this.htmlElements.qrtContent,""),q.publish(n,e)}}class se{constructor(e){this.htmlElements={methodGroups:document.getElementById("method-groups"),primaryMethods:document.getElementById("primary"),authButton:document.getElementById("auth-button"),switchPrimaryBtn:document.getElementById("switch-primary-group"),cancelBtn:document.getElementById("cancel-btn")},this.hideAllChildren();const t=document.querySelector(`[data-id=${e.id}]`),s=null==t?void 0:t.querySelector("input");s?(s.checked=!0,B.focusElement(s),B.removeClass(t,"hidden"),q.publish(m,s.id)):x.log("Group handler: No sub methods configured",N.error),B.removeClass(this.htmlElements.switchPrimaryBtn,"hidden"),B.addClass(this.htmlElements.cancelBtn,"hidden"),B.addEventListener(this.htmlElements.switchPrimaryBtn,"click",(()=>this.switchToPrimaryGroup(e.id)))}static init(e){return new se(e)}hideAllChildren(){[].slice.call(this.htmlElements.methodGroups.children).forEach((e=>B.addClass(e,"hidden")))}switchToPrimaryGroup(e){this.hideAllChildren(),q.publish(m,e);const t=document.getElementById(e);t.checked=!0,B.focusElement(t),B.removeClass(this.htmlElements.primaryMethods,"hidden"),B.addClass(this.htmlElements.switchPrimaryBtn,"hidden"),B.removeClass(this.htmlElements.cancelBtn,"hidden")}}class ie{constructor(e,t){q.publish(r,"show"),this.currentMethod=e,this.htmlElements={signingText:document.getElementById("signing-text"),signingSubmit:document.getElementById("signing-button"),signingCancel:document.getElementById("signing-cancel")},t.sessionId?this.validateResponse(t):this.fetchRequestParams()}static init(e,t){return new ie(e,t)}fetchRequestParams(){const e=window.btoa(JSON.stringify({mid:this.currentMethod.id,avn:P.config.av,dml:P.config.dm,dal:P.config.ec,ste:P.config.requestParams.state}));B.xhr({url:`${this.currentMethod.url}`,method:"POST",body:Object.assign(Object.assign({},P.config.requestParams),{ui_locales:P.config.lang,client_data:e,initialisation_token:P.config.initToken}),success:e=>e.text_to_be_signed?this.displaySigningText(e):this.handleResponse(e),error:e=>q.publish(n,e)})}displaySigningText(e){B.setCurrentView(I),B.addInnerHTMLContent(this.htmlElements.signingText,e.text_to_be_signed),B.addEventListener(this.htmlElements.signingCancel,"click",(()=>q.publish(n,{error:L.CANCELLED}))),B.addEventListener(this.htmlElements.signingSubmit,"click",(()=>this.handleResponse(e))),q.publish(r,"hide")}handleResponse(e){if(q.publish(r,"show"),e.saml_params){const t={SAMLRequest:e.saml_params.saml_request,RelayState:e.state};B.createAndSubmitForm(t,e.url,"POST","ftn-form")}else{const{url:t,oidc_params:s}=e,i=B.getUrl(t,s);B.locationAssign(i)}}validate(e,t){const{level:s,samlResponseExceptionIndicator:i}=P.config,r=Object.assign(Object.assign({response:t},s&&{saml_level:s}),i&&{saml_response_exception_indicator:i});B.xhr({url:`${this.currentMethod.url}/${e}`,method:"PATCH",body:r,success:e=>this.onValidationResult(e),error:e=>q.publish(n,e)})}onValidationResult(e){const t=P.config.requestParams;B.isIEUrlTooLong(t.redirect_uri,t.state,e.code)?q.publish(n,{error:L.REDIRECT_URL_TOO_LONG,type:L.TECHNICAL}):q.publish(o,{code:e.code})}validateResponse(e){if(e.error){const{error:t}=e,s=t.includes("cancel")||t===L.ACCESS_DENIED;q.publish(n,{error:s?L.CANCELLED:e.error})}else this.validate(e.sessionId,e.code)}}class re{constructor(e,t){this.hasErrors=!0,this.USE_CASE="BANKID",this.LAST_LOGIN_ATTEMPT=1,this.currentMethod=e,this.userId=t.user_id,this.htmlElements={confirmationCodeForm:document.getElementById("confirmation-code-form"),confirmationCodeInput:document.getElementById("confirmation-code-input"),confirmationCodeSubmit:document.getElementById("confirmation-code-button"),confirmationCodeCancel:document.getElementById("confirmation-code-cancel"),signText:document.getElementById("confirmation-code-sign-text"),confirmationCodeError:document.getElementById("confirmation-code-error"),respError:document.getElementById("confirmation-code-resp-error")},this.start()}static init(e,t){return new re(e,t)}start(){B.xhr({before:()=>q.publish(r,"show"),url:`${this.currentMethod.url}/confirmation-codes/orders/${P.config.requestParams.signing_order_id}?client_id=${P.config.requestParams.client_id}`,method:"GET",success:e=>this.displayConfirmationCode(e.text_to_be_signed),error:e=>q.publish(n,e),acceptLanguage:P.config.lang})}displayConfirmationCode(e){q.publish(r,"hide"),B.setCurrentView("confirmation-code-form"),e&&(B.addInnerHTMLContent(this.htmlElements.signText,e),B.removeClass(this.htmlElements.signText,"hidden")),B.focusElement(this.htmlElements.confirmationCodeInput),this.addEventListeners()}addEventListeners(){B.addEventListener(this.htmlElements.confirmationCodeInput,"input",(()=>this.checkFormValidity())),B.addEventListener(this.htmlElements.confirmationCodeForm,"submit",(e=>this.handleFormSubmit(e))),B.addEventListener(this.htmlElements.confirmationCodeCancel,"click",(()=>this.handleFormCancel()))}checkFormValidity(){this.hasErrors=!B.hasClass(this.htmlElements.confirmationCodeInput,"valid"),B.setAttribute(this.htmlElements.confirmationCodeSubmit,"aria-disabled",this.hasErrors.toString())}handleFormSubmit(e){if(e.preventDefault(),!this.hasErrors){const e=this.htmlElements.confirmationCodeInput.value;this.verify(e)}}verify(e){B.xhr({before:()=>q.publish(r,"show"),url:`${this.currentMethod.url}/confirmation-codes/users/${this.userId}/verify`,method:"POST",body:Object.assign(Object.assign({},P.config.requestParams),{confirmation_code:e,use_case:this.USE_CASE}),success:e=>q.publish(o,{code:e.authorization_code,loginHint:B.handleLoginHint(e.user_id,this.userId,this.currentMethod.id)}),error:e=>this.handleVerifyError(e),acceptLanguage:P.config.lang})}handleFormCancel(){q.publish(n,{error:"cancelled"})}handleVerifyError(e){if(401!==e.http_status||"invalid"!==e.error&&"detained"!==e.error)q.publish(n,e);else{let t;B.clearInputElement(this.htmlElements.confirmationCodeInput),B.removeClass(this.htmlElements.confirmationCodeInput,"valid"),t="invalid"===e.error?this.LAST_LOGIN_ATTEMPT===e.remaining_attempts?"ccode_last_attempt_error":"ccode_default_error":"ccode_blocked_error",B.addInnerHTMLContent(this.htmlElements.confirmationCodeError,P.config.errors[t]),B.removeClass(this.htmlElements.respError,"hidden"),B.focusElement(this.htmlElements.confirmationCodeInput),q.publish(r,"hide"),this.checkFormValidity()}}}class ne extends ${constructor(e,t){super(),this.isSameDeviceFlow=!1,this.SWITCHVIEW_TIMEOUT=375,this.PAGE_EXPIRATION_TIMEOUT=18e4,this.URL_SCHEME="bankid:///c?autostarttoken=[TOKEN]&redirect=null",this.APP_LINK="https://app.bankid.com/c?autostarttoken=[TOKEN]&redirect=null",this.isPageExpired=!1,this.viewSwitched=!1,this.personalNumber=t.personal_number,this.currentMethod=e,this.sessionId=P.config.sessionId,this.requestHash=P.config.requestHash,this.retry=P.config.retry,this.htmlElements={cancel:[].slice.call(document.querySelectorAll(".cancel-bankidse")),openApplication:document.getElementById("open-bankidseapp-passport"),otherDevice:document.getElementById("other-device-passport"),sameDevice:document.getElementById("same-device-passport"),statusContainer:document.getElementById("status-container-bankidse-passport"),qrCodeContent:document.getElementById("qr-code-passport"),qrCodeContainer:document.getElementById("qr-code-container-passport"),retry:document.querySelector(".try-again-bankidse"),sameFlowInfo:document.getElementById("same-flow-info-passport"),frameWrapper:document.getElementById("frame-wrapper-bankidse-passport")},this.addEventListeners(),this.checkSameDeviceFlow(),B.isQrCodeLibraryExist()?this.sessionId?this.tryRecovery():this.startAuth():this.handleError({error:L.QR_CODE_GENERATE_ERROR,type:L.TECHNICAL})}static init(e,t){return new ne(e,t)}addEventListeners(){B.addEventListener(this.htmlElements.retry,"click",(()=>this.startAuth())),B.addEventListener(this.htmlElements.sameDevice,"click",(()=>this.changeFlow("same"))),B.addEventListener(this.htmlElements.otherDevice,"click",(()=>this.changeFlow("other"))),this.htmlElements.cancel.forEach((e=>B.addEventListener(e,"click",(()=>this.handleCancel()))))}checkSameDeviceFlow(){"desktop"===P.config.deviceType?(this.isSameDeviceFlow=!1,B.removeData("flow",!1)):this.getSavedFlow()}getSavedFlow(){const e=B.getData("flow",!1);this.isSameDeviceFlow=e?"same"===e:B.isMobileDevice()}changeFlow(e){q.publish(r,"show"),q.publish(E,e),this.clearTimers(),B.setData("flow",e,!1),this.isSameDeviceFlow="same"===e,this.pollRequest&&this.pollRequest.abort(),this.restartAuth()}setPageExpirationTimer(){this.pageExpirationTimer||(this.pageExpirationTimer=window.setTimeout((()=>{this.responseLatestStatus===y&&this.onPageExpiredError()}),this.PAGE_EXPIRATION_TIMEOUT))}onPageExpiredError(){this.isPageExpired=!0,this.onError({error:this.isSameDeviceFlow?L.BANKID_OPEN_ERROR:L.BANKID_QR_CODE_SCAN_ERROR})}tryRecovery(){this.retry?(this.url=`${this.currentMethod.url}/${this.sessionId}`,this.recovery=!0,this.pollStatus()):this.cancelAuthenticationAndClearSession()}startAuth(){B.xhr({before:()=>q.publish(r,"show"),url:this.currentMethod.url,method:"POST",body:Object.assign(Object.assign({},P.config.requestParams),{personal_number:this.personalNumber}),success:e=>this.authenticate(e),error:e=>this.onError(e),acceptLanguage:P.config.lang})}authenticate(e){this.sessionId=e.session_id,this.url=`${this.currentMethod.url}/${e.session_id}`,this.updateSessionCookies(this.sessionId,this.currentMethod.id,this.requestHash),this.responseLatestStatus=e.status,this.setPageExpirationTimer(),this.isSameDeviceFlow?this.showSameDeviceFlow(e):this.showOtherDeviceFlow(e)}getSameDeviceAppUrl(e){let t=this.URL_SCHEME.replace("[TOKEN]",e);return"IOS"!==P.config.platform.toUpperCase()||this.requiresUrlSchemeOnIos()?"ANDROID"!==P.config.platform.toUpperCase()||this.requiresNoIframeOnAndroid()||this.createFrame("bankid-frame","BankID",this.htmlElements.frameWrapper):t=this.APP_LINK.replace("[TOKEN]",e),t=this.getAppUrl(t,"redirect"),t}showSameDeviceFlow(e){const{auto_start_token:t,status:s,verify_after:i}=e,r=this.getSameDeviceAppUrl(t);this.openApp=()=>{this.frameWindow?B.dynamicLocationAssign(this.frameWindow,r):B.topLocationAssign(r)},B.addEventListener(this.htmlElements.openApplication,"click",this.openApp),this.updateStatus(s,this.htmlElements.statusContainer.parentElement,this),this.poll(i),this.setView(f,this.htmlElements.statusContainer),B.getInstalledApps(this.currentMethod.id,this.APPS)&&this.openApp()}showOtherDeviceFlow(e){const{qr_data:t,verify_after:s}=e;this.updateQrCodeAndPoll(t,s,!0)}poll(e,t=!0){t&&(this.pollingStartTime=Date.now()),this.pollTimer=window.setTimeout((()=>this.pollStatus(e)),e)}switchToPendingView(){q.publish(r,"show"),this.viewSwitched=!0,this.isSameDeviceFlow||(B.addClass(this.htmlElements.statusContainer,"pending-other"),this.htmlElements.sameFlowInfo.dataset.flowInfoTarget="bankidse-passport-after-scan"),setTimeout((()=>{this.setView(f,this.htmlElements.statusContainer)}),this.SWITCHVIEW_TIMEOUT)}checkStatus(e){const{status:t,verify_after:s,code:i,qr_data:r}=e;switch(t){case y:this.onAssignmentPending(t,r,s);break;case v:this.onConfirmationPending(t,s);break;case w:this.handleError({error:L.CANCELLED});break;case S:case T:this.onSuccess(i);break;default:this.onError(e)}}onAssignmentPending(e,t,s){if(this.recovery||this.isSameDeviceFlow){if(this.recovery)return this.recovery=!1,void this.cancelAuthenticationAndClearSession();this.triggerUpdateStatus(e),this.poll(s)}else this.updateQrCodeAndPoll(t,s)}triggerUpdateStatus(e){this.updateStatus(e,this.htmlElements.statusContainer.parentElement,this)}onConfirmationPending(e,t){(this.recovery||!this.isSameDeviceFlow&&!1===this.viewSwitched)&&this.switchToPendingView(),this.triggerUpdateStatus(e),this.poll(t)}onSuccess(e){this.triggerUpdateStatus(T),this.clearCookies(),this.clearTimers(),this.successTimer=window.setTimeout((()=>{q.publish(o,{code:e,loginHint:this.currentMethod.id})}),this.SUCCESS_TIMEOUT)}pollStatus(e=this.defaultPollTimeout){this.pollRequest=B.xhr({url:this.url,requestError:()=>this.onRequestError((()=>this.poll(e,!1)),(()=>this.onError({error:L.REQUEST_FAILED}))),success:e=>{this.isPageExpired||(this.responseLatestStatus=e.status,this.checkStatus(e))},error:e=>this.onPollError(e)})}onPollError(e){const{error:t}=e;this.recovery?t===L.AUTHENTICATION_COLLISION?this.onError({error:L.RETRY_COLLISION}):this.cancelAuthenticationAndClearSession():this.isPageExpired||(t===L.START_FAILED?this.restartAuth():this.onError(e))}restartAuth(){this.viewSwitched=!1,B.removeEventListener(this.htmlElements.openApplication,"click",this.openApp),this.startAuth()}handleCancel(){this.onError({error:L.CANCELLED})}onError(e){this.clearTimers(),this.handleError(e)}clearTimers(){window.clearTimeout(this.pollTimer),window.clearTimeout(this.pageExpirationTimer),this.pollTimer=null,this.pageExpirationTimer=null}updateQrCodeAndPoll(e,t,s=!1){QRCode.toDataURL(e,{errorCorrectionLevel:"M",width:k,margin:3},((e,i)=>{if(e)return void this.onError({error:L.QR_CODE_GENERATE_ERROR,type:L.TECHNICAL});const r=this.htmlElements.qrCodeContent;r.width=k,r.height=k,r.src=i,s&&this.setView("bankidse-passport-qr-code",this.htmlElements.qrCodeContainer),this.poll(t)}))}cancelAuthenticationAndClearSession(){this.clearCookies(),B.locationReload()}}class oe{constructor(){this.PAGE_READY_DELAY=1e3,this.SLOW_REDIRECTION_DELAY=2500,this.handlers={bankidse3ds:Q,bankidno:W,bankidse:j,bankidse_passport:ne,challenge:J,confirmationcode:re,ftn:ie,group:se,immediate:G,mitid:K,mta:Y,otpvalidation:Z,personal_code:ee,qrt:te},this.currentMethod=P.config[P.config.defaultMethod],this.htmlElements={body:document.body,lazyImages:[].slice.call(document.querySelectorAll(".lazy-image")),contentLoader:document.getElementById("content-loader"),cancelLinks:[].slice.call(document.querySelectorAll(".cancel-link"))},B.isEmbedded()&&B.addClass(document.documentElement,"framed"),this.onLoad()}static init(){return new oe}onLoad(){this.addEventListeners(),setTimeout((()=>B.addClass(this.htmlElements.body,"page-ready")),this.PAGE_READY_DELAY),P.config.autoSubmit||this.hideLoader()}onSwitchMethod(e){this.currentMethod=e}onSuccess(e={}){const{code:t,userAccountsCalled:s=!1,loginHint:i,isNonDigitalUserid:r=!1}=e,n=!(P.config.agreement||P.config.cuaie),o=r&&("optional"===P.config.agreement||P.config.cuaie);s||n||o?this.redirect(t,i):z.getAgreement(t,i)}redirect(e,t){const{client_id:s,redirect_uri:i,state:r}=P.config.requestParams,{allowManualRedirect:n,noAppUrlAutoRedirect:o}=P.config;if(this.showLoader(!n),!B.isEmbedded()||P.config.forceRedirect){const a=Object.assign({client_id:s,redirect_uri:i,state:r,code:e},t&&{login_hint:t});if(n||o){x.log("Showing manual redirect button");const e=document.getElementById("manual-redirect-btn");B.addEventListener(e,"click",(()=>this.doRedirect(a,"post-success-form"))),setTimeout((()=>B.setCurrentView("manual-redirect",e)),o?0:this.SLOW_REDIRECTION_DELAY),setTimeout((()=>this.hideLoader()),o?0:this.SLOW_REDIRECTION_DELAY)}if(o)return void x.log("Auto-redirect is disabled");setTimeout((()=>x.log("Auto-redirect slow or prevented by browser or OS")),this.SLOW_REDIRECTION_DELAY),this.doRedirect(a,"success-form")}else{const s=t?{code:e,state:r,login_hint:t}:{code:e,state:r};B.postMessage(s,P.config.requestParams.redirect_uri)}}doRedirect(e,t){B.createAndSubmitForm(e,A,"POST",t)}initAuth(e={}){const{params:t={}}=e;this.handlers[this.currentMethod.type].init(this.currentMethod,t)}addEventListeners(){B.addEventListener(window,"load",(()=>this.loadLazyImages())),q.subscribe(s,(e=>this.initAuth(e))),q.subscribe(i,(e=>this.onSwitchMethod(e))),q.subscribe(r,(e=>this.onToggleLoading(e))),q.subscribe(o,(e=>this.onSuccess(e))),this.htmlElements.cancelLinks.forEach((e=>{B.addEventListener(e,"click",(e=>this.onCancel(e)))}))}onToggleLoading(e){"show"===e?this.showLoader():this.hideLoader()}showLoader(e=!1){B.addClass(this.htmlElements.body,"loading"),e&&B.addClass(this.htmlElements.body,"redirecting"),setTimeout((()=>{(B.hasClass(this.htmlElements.body,"loading")||B.hasClass(this.htmlElements.body,"redirecting"))&&this.htmlElements.contentLoader.focus()}),100)}hideLoader(){B.removeClass(this.htmlElements.body,"redirecting"),B.removeClass(this.htmlElements.body,"loading")}loadLazyImages(){this.htmlElements.lazyImages.forEach((e=>e.src=e.dataset.src))}onCancel(e){this.showLoader(!P.config.allowManualRedirect),!B.isEmbedded()||P.config.forceRedirect?B.createAndSubmitForm({client_id:P.config.requestParams.client_id,redirect_uri:P.config.requestParams.redirect_uri,error:"cancelled",state:P.config.requestParams.state},A,"POST","cancel-form"):(e.preventDefault(),B.postMessage({error:P.config.errors.cancelled,state:P.config.requestParams.state},P.config.requestParams.redirect_uri))}}class ae{constructor(){this.inputHints=[],this.inputElements=[].slice.call(document.querySelectorAll("[data-manage]")),this.addInputHints(),this.addValidations(),this.addEventListeners()}static init(){return new ae}addInputHints(){this.inputElements.forEach((e=>{if(void 0!==e.dataset.showHint){const t=B.createElement("button",{attributes:{type:"button","aria-label":P.config.texts.showInputHint},classes:["input-hint","icon-button","button"]});this.inputHints.push(t),e.parentNode.insertBefore(t,e.nextSibling)}}))}clearValidity(e){this.clearError(e.closest(".input-wrapper")),B.removeClass(e,"valid")}checkInputLength(e){this.validations[e.id].length.test(e.value.replace(/ /g,""))&&this.onValidInput(e)}onValidInput(e){this.clearValidity(e),B.addClass(e,"valid")}onInputChange(e){this.clearValidity(e);const t=e.closest(".input-wrapper");e.value?(B.addClass(t,"has-value"),this.validations[e.id].pattern.test(e.value)?(this.clearError(t),this.checkInputLength(e)):this.showError(e)):B.removeClass(t,"has-value")}showError(e){const t=e.closest(".input-wrapper");B.addClass(t,"has-error"),B.setAttribute(t.querySelector(".input-error"),"aria-hidden","false")}clearError(e){B.removeClass(e,"has-error"),B.setAttribute(e.querySelector(".input-error"),"aria-hidden","true"),B.addClass(e.querySelector(".verify-error"),"hidden")}addValidations(){this.validations=this.inputElements.reduce(((e,t)=>(e[t.id]={pattern:new RegExp(t.dataset.validation?t.dataset.validation:"^.+$"),length:new RegExp(`^.{${t.dataset.min},${t.dataset.max}}$`)},e)),{})}resetInput(e){e.value="","password"===e.dataset.type&&B.addClass(e,e.dataset.type),B.removeClass(e.closest(".input-wrapper"),"has-value"),B.removeClass(e.nextElementSibling,"visible"),this.clearValidity(e)}onHintClick(e){B.toggleClass(e,"visible"),B.setAttribute(e,"aria-label",B.hasClass(e,"visible")?P.config.texts.hideInputHint:P.config.texts.showInputHint);const t=e.previousElementSibling;B.toggleClass(e.previousElementSibling,"password"),t.focus()}addEventListeners(){this.inputElements.forEach((e=>{B.addEventListener(e,"input",(e=>this.onInputChange(e.target))),e.value&&this.onInputChange(e)})),this.inputHints.forEach((e=>{B.addEventListener(e,"click",(e=>this.onHintClick(e.target)))})),q.subscribe(l,(e=>this.resetInput(e))),q.subscribe(d,(e=>this.showError(e))),q.subscribe(h,(e=>this.clearValidity(e))),q.subscribe(c,(e=>this.onValidInput(e)))}}class le{constructor(){this.BLOCK_LENGTH=3,this.inputElements=[].slice.call(document.querySelectorAll("[data-format]")),this.inputElements.forEach((e=>B.addEventListener(e,"input",(e=>this.formatInput(e)))))}static init(){return new le}formatInput(e){e.preventDefault();const t=e.target,s=t.getAttribute("data-val");let i=-1;null!=s&&null!=t.value&&(s.length!==t.value.length&&(i=t.selectionStart),s.length<t.value.length&&i%(this.BLOCK_LENGTH+1)==0&&i++);const r=t.value.replace(/ /g,""),n=new RegExp(`.{${this.BLOCK_LENGTH}}`,"g"),o=r.replace(n,"$& ").trim().substring(0,11).trim();t.value=o,t.setAttribute("data-val",o),i>=0&&setTimeout((()=>t.setSelectionRange(i,i)),1)}}class he{constructor(){this.htmlElements={closeErrorBtn:document.getElementById("error-close"),doRedirectErrorBtn:document.getElementById("error-do-redirect"),errorMessage:document.getElementById("error-message"),errorContainer:document.getElementById("error-view"),errors:document.getElementById("errors"),error_default:document.getElementById("default-error"),error_request_failed:document.getElementById("request-error"),error_failed:document.getElementById("request-error"),error_cancelled:document.getElementById("cancel-error"),error_empty:document.getElementById("empty-error"),error_technical:document.getElementById("technical-error"),error_session_expired:document.getElementById("session-error")},this.addEventListeners()}static init(){return new he}addEventListeners(){q.subscribe(n,(e=>this.onError(e))),B.addEventListener(this.htmlElements.closeErrorBtn,"click",(e=>this.onCloseErrorBtnClick(e))),B.addEventListener(this.htmlElements.doRedirectErrorBtn,"click",(()=>this.doRedirect()))}onCloseErrorBtnClick(e){!1===P.config.startOver?this.doRedirect():void 0!==e.target.dataset.addParams?this.addParamsAndStartOver():B.locationReplace(B.removeParameter("login_hint",location.href))}doRedirect(){B.createAndSubmitForm({redirect_uri:P.config.requestParams.redirect_uri,state:P.config.requestParams.state,error:B.mapServiceErrors(this.error),client_id:P.config.requestParams.client_id},A,"POST","close-error-form")}addParamsAndStartOver(){const e=Object.assign(Object.assign({},P.config.requestParams),{ui_locales:P.config.lang}),t=`${location.protocol}//${location.host}?`+Object.keys(e).filter((t=>e[t])).map((t=>`${t}=${encodeURIComponent(e[t])}`)).join("&");B.locationReplace(t)}onError(e={}){const{status:t,error:s,type:i="default"}=e,n=P.config.errors[t]||P.config.errors[s]||P.config.errors.error_default,o=this.htmlElements[`error_${s}`]||this.htmlElements[`error_${i}`]||this.htmlElements.error_default;this.error=s,!B.isEmbedded()||P.config.forceRedirect?(P.config.showExceptions&&this.showExceptions(e),[].slice.call(this.htmlElements.errors.children).forEach((e=>B.addClass(e,"hidden"))),B.addHTMLContent(this.htmlElements.errorMessage,n),B.removeClass(o,"hidden"),s===L.SESSION_EXPIRED&&(B.addClass(this.htmlElements.closeErrorBtn,"hidden"),B.removeClass(this.htmlElements.doRedirectErrorBtn,"hidden")),B.setCurrentView("error",this.htmlElements.closeErrorBtn),q.publish(r,"hide"),q.publish("onError")):B.postMessage({error:n,state:P.config.requestParams.state},P.config.requestParams.redirect_uri),x.log(JSON.stringify(e),e.error===L.CANCELLED?N.info:N.error)}showExceptions(e={}){const t=document.getElementById("ex");B.addContent(t,JSON.stringify(e,null,4)),e.error===L.CANCELLED&&B.addClass(t.parentElement,"info")}}class de{constructor(){this.focusElements="button, [href], input, select, textarea",this.escInputHandler=this.handleEscPressed.bind(this),this.htmlElements={html:document.documentElement,togglers:[].slice.call(document.querySelectorAll("[data-toggle-notification]")),backdrop:document.getElementById("notification-backdrop"),contents:[].slice.call(document.querySelectorAll("[data-notification-content]")),notification:document.getElementById("notification"),container:document.getElementById("notification-content")},this.htmlElements.contents.forEach((e=>this.htmlElements.container.appendChild(e))),this.addEventListeners()}static init(){return new de}addEventListeners(){B.addEventListener(this.htmlElements.notification,"keydown",(e=>this.handleKeyDown(e))),this.htmlElements.togglers.forEach((e=>{B.addEventListener(e,"click",(e=>this.toggleModal(e.currentTarget)))})),B.addEventListener(this.htmlElements.backdrop,"click",(()=>this.onBackdropClick()))}onBackdropClick(){this.isModal?B.focusElement(this.firstFocusElement):this.hide()}show(e,t){const s=t||document.body.querySelectorAll(this.focusElements)[0];this.showNotification(e,s)}hide(){B.removeClass(document.body,"hide-overflow"),B.removeEventListener(document.body,"keydown",this.escInputHandler),B.removeClass(this.htmlElements.notification,"visible"),B.focusElement(this.returnFocusElem)}toggleModal(e){this.isVisible()?this.hide():this.showNotification(e.dataset.notificationTarget,e)}setContent(e,t){if(this.target=document.querySelector(`[data-notification-id=${e}]`),!this.target)throw new Error("No target content found.");this.returnFocusElem=t,this.isModal=void 0!==this.target.dataset.ismodal,this.createFocusOrder()}createFocusOrder(){const e=this.target.querySelectorAll(this.focusElements);this.firstFocusElement=e[0],this.lastFocusElement=e[e.length-1]}showNotification(e,t){try{B.addClass(document.body,"hide-overflow"),this.setContent(e,t),B.addClass(this.htmlElements.notification,"visible"),this.htmlElements.contents.forEach((e=>B.removeClass(e,"visible"))),B.addEventListener(document.body,"keydown",this.escInputHandler),B.addClass(this.target,"visible"),B.focusElement(this.firstFocusElement),setTimeout((()=>this.target.scrollTop=0),110),B.addClass(this.htmlElements.html,"message-seen")}catch(e){x.log(e,N.error)}}isVisible(){return B.hasClass(this.htmlElements.notification,"visible")}handleKeyDown(e){const t=e.shiftKey;("Tab"===e.key||9===e.keyCode)&&(t?document.activeElement===this.firstFocusElement&&(B.focusElement(this.lastFocusElement),e.preventDefault()):document.activeElement===this.lastFocusElement&&(B.focusElement(this.firstFocusElement),e.preventDefault()))}handleEscPressed(e){const t=e.key||e.keyCode;this.isModal||"Escape"!==t&&"Esc"!==t&&27!==t||(e.preventDefault(),this.hide())}}class ce{constructor(){this.SSN_LEN=11,this.SSN_REG=/^\d{6}[+\-ABCDEFYXWVU]\d{0,3}(\d{3}(?![GIOQZ])[0-9A-Z])?$/,this.NUMBER_REG=/^\d+$/,[].slice.call(document.querySelectorAll("input[data-ssn-validator]")).forEach((e=>{B.addEventListener(e,"input",(e=>this.checkInput(e.target))),e.value&&this.checkInput(e)}))}static init(){return new ce}checkInput(e){const t=e.value.toUpperCase();if(t&&!this.NUMBER_REG.test(t)&&t.length<=this.SSN_LEN){q.publish(h,e);const s=this.SSN_REG.test(t);t.length===this.SSN_LEN&&s?q.publish(c,e):s||q.publish(d,e)}}}const ue=e=>{P.config=e,F.init(),he.init(),ae.init(),le.init(),ce.init(),oe.init(),de.init(),e.systemMessages&&U.init(),V.init()},me=(e,t,i,r)=>{P.config=e,he.init(),oe.init(),q.publish(s,{params:{sessionId:t,code:i,error:r}})},Ee=e=>{!B.isEmbedded()||e?B.locationAssign("/error"):B.postMessage({error:!0},location.href)};App=t}();